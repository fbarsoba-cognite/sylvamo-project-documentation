[
  {
    "external_id": "tr-csv-to-assets",
    "name": "table-to-assets",
    "query": "/* MAPPING_MODE_ENABLED: false */\n/* {\"version\":1,\"sourceType\":\"raw\",\"mappings\":[{\"from\":\"name\",\"to\":\"externalId\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"_type\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"aliases\",\"asType\":\"ARRAY<STRING>\"},{\"from\":\"name\",\"to\":\"name\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"source\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"path\",\"asType\":\"ARRAY<STRUCT<`space`:STRING, `externalId`:STRING>>\"},{\"from\":\"\",\"to\":\"root\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"assetClass\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"sourceUpdatedUser\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"pathLastUpdatedTime\",\"asType\":\"TIMESTAMP\"},{\"from\":\"\",\"to\":\"sourceUpdatedTime\",\"asType\":\"TIMESTAMP\"},{\"from\":\"\",\"to\":\"type\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"sourceCreatedUser\",\"asType\":\"STRING\"},{\"from\":\"parent\",\"to\":\"parent\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"description\",\"to\":\"description\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"tags\",\"asType\":\"ARRAY<STRING>\"},{\"from\":\"\",\"to\":\"sourceCreatedTime\",\"asType\":\"TIMESTAMP\"},{\"from\":\"\",\"to\":\"sourceContext\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"sourceId\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"object3D\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"}],\"sourceLevel1\":\"assets\",\"sourceLevel2\":\"asset\"} */\nselect\n  cast(`name` as STRING) as externalId,\n  cast(`name` as STRING) as name,\n  node_reference(\"eastover-assets\", `parent`) as parent,\n  cast(`description` as STRING) as description\nfrom\n  `assets`.`asset`;",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Instances"
  },
  {
    "external_id": "tr-csv-to-workorders",
    "name": "table-to-workorders",
    "query": "select\n  cast(`id` as STRING) as externalId,\n  to_timestamp(`endTime`, 'M/d/yyyy H:mm') as endTime,\n  cast(`priority` as STRING) as priorityDescription,\n  cast(`type` as STRING) as type,\n  cast(`name` as STRING) as name,\n  to_timestamp(`startTime`, 'M/d/yyyy H:mm') as startTime,\n  cast(`description` as STRING) as description,\n  cast(`status` as STRING) as status,\n  transform(split(`assets`, ',\\\\s*'), asset -> node_reference(\"eastover-assets\", asset)) as assets\nfrom\n  `workorders`.`wo`;\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Instances"
  },
  {
    "external_id": "tr-table-to-assets2",
    "name": "table-to-assets2",
    "query": "/* MAPPING_MODE_ENABLED: false */\n/* {\"version\":1,\"sourceType\":\"raw\",\"mappings\":[{\"from\":\"name\",\"to\":\"externalId\",\"asType\":\"STRING\"},{\"from\":\"parent\",\"to\":\"parentExternalId\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"source\",\"asType\":\"STRING\"},{\"from\":\"name\",\"to\":\"name\",\"asType\":\"STRING\"},{\"from\":\"description\",\"to\":\"description\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"metadata\",\"asType\":\"MAP<STRING, STRING>\"},{\"from\":\"\",\"to\":\"dataSetId\",\"asType\":\"BIGINT\"},{\"from\":\"\",\"to\":\"labels\",\"asType\":\"ARRAY<STRING>\"}],\"sourceLevel1\":\"assets\",\"sourceLevel2\":\"asset\"} */\nselect\n  cast(concat('asset:', `name`) as STRING) as externalId,\n  cast(\n    case \n      when `parent` is null then '' \n      else concat('asset:', `parent`) \n    end \n    as STRING\n  ) as parentExternalId,\n  cast(`name` as STRING) as name,\n  cast(`description` as STRING) as description\nfrom\n  `assets`.`asset`;",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "TransformationDestination"
  },
  {
    "external_id": "tr-table-to-workorders2",
    "name": "table-to-workorders2",
    "query": "with work_orders as (\n    select\n        to_timestamp(`startTime`, 'M/d/yyyy H:mm') as startTime,\n        to_timestamp(`endTime`, 'M/d/yyyy H:mm') as endTime,\n        `description` as description,\n        `type` as type,\n        `id` as externalId,\n        split(`assets`, ', ') as assetNames\n    from\n        `workorders`.`wo`\n),\nexploded_assets as (\n    select\n        wo.externalId,\n        wo.startTime,\n        wo.endTime,\n        wo.description,\n        wo.type,\n        trim(assetName) as assetName\n    from\n        work_orders wo\n        lateral view explode(wo.assetNames) t as assetName\n),\njoined_assets as (\n    select\n        ea.externalId,\n        ea.startTime,\n        ea.endTime,\n        ea.description,\n        ea.type,\n        a.id as assetId\n    from\n        exploded_assets ea\n        join `_cdf`.`assets` a\n            on concat('asset:', ea.assetName) = a.externalId\n)\nselect\n    externalId,\n    startTime,\n    endTime,\n    description,\n    type,\n    collect_list(assetId) as assetIds\nfrom\n    joined_assets\ngroup by\n    externalId, startTime, endTime, description, type\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "TransformationDestination"
  },
  {
    "external_id": "tr-materials-to-CostCalc",
    "name": "materials-to-CostCalc",
    "query": "/* MAPPING_MODE_ENABLED: true */\n/* {\"version\":1,\"sourceType\":\"raw\",\"mappings\":[{\"from\":\"Material Code\",\"to\":\"externalId\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"_type\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"Material Code\",\"to\":\"materialCode\",\"asType\":\"STRING\"},{\"from\":\"Supplier\",\"to\":\"supplier\",\"asType\":\"STRING\"},{\"from\":\"Unit Cost ($/kg)\",\"to\":\"unitCost\",\"asType\":\"DOUBLE\"},{\"from\":\"Cost Source\",\"to\":\"costSource\",\"asType\":\"STRING\"}],\"sourceLevel1\":\"SAP_costs\",\"sourceLevel2\":\"material_costs\"} */\nselect\n  cast(`Material Code` as STRING) as externalId,\n  cast(`Material Code` as STRING) as materialCode,\n  cast(`Supplier` as STRING) as supplier,\n  cast(`Unit Cost ($/kg)` as DOUBLE) as unitCost,\n  cast(`Cost Source` as STRING) as costSource\nfrom\n  `SAP_costs`.`material_costs`;",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Instances"
  },
  {
    "external_id": "5e04057a-d7b7-4d6c-9039-791a66b4d35e",
    "name": "BOM-to-CostCalc",
    "query": "/* MAPPING_MODE_ENABLED: false */\n/* {\"version\":1,\"sourceType\":\"raw\",\"mappings\":[{\"from\":\"Material Code\",\"to\":\"externalId\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"_type\"},{\"from\":\"Description\",\"to\":\"description\",\"asType\":\"STRING\"},{\"from\":\"Material Code\",\"to\":\"materialCode\",\"asType\":\"STRING\"},{\"from\":\"Usage per Ton (kg)\",\"to\":\"usagePerTon\",\"asType\":\"INT\"},{\"from\":\"\",\"to\":\"material\"},{\"from\":\"Unit of Measure\",\"to\":\"uom\",\"asType\":\"STRING\"}],\"sourceLevel1\":\"SAP_costs\",\"sourceLevel2\":\"BOM\"} */\nselect\n  cast(`Material Code` as STRING) as externalId,\n  cast(`Description` as STRING) as description,\n  cast(`Material Code` as STRING) as materialCode,\n  cast(`Usage per Ton (kg)` as INT) as usagePerTon,\n  ARRAY(node_reference(\"costs\", `Material Code`)) as material,\n  cast(`Unit of Measure` as STRING) as uom\nfrom\n  `SAP_costs`.`BOM`;",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Instances"
  },
  {
    "external_id": "tr_populate_FunctionalLocations",
    "name": "[Enterprise] Populate FunctionalLocation from SAP FLOCs",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate FunctionalLocation (Enterprise View)\n   \n   Purpose:\n   - Creates enterprise view instances (FunctionalLocation) for SAP functional locations\n   - Works alongside existing CogniteAsset instances\n   - Enables data to appear in enterprise search (not just core search)\n   \n   Source: raw_ext_sap.asset_hierarchy (ingested from SAP Tables in Fabric.xlsx)\n   \n   Updated: 2026-01-27 - Now uses new asset_hierarchy table with work center info\n*/\n\nwith hierarchy_data as (\n    -- Read from new SAP asset hierarchy table\n    select\n        functional_location as floc,\n        functional_location_description as description,\n        hierarchy_level,\n        work_center_code,\n        work_center_description,\n        equipment,\n        -- Extract plant code from FLOC (first 4 chars)\n        substring(functional_location, 1, 4) as plant_code,\n        -- Derive location category from hierarchy_level\n        case\n            when hierarchy_level = 1 then 'Mill'\n            when hierarchy_level = 2 then 'Area'\n            when hierarchy_level = 3 then 'ProcessLine'\n            when hierarchy_level = 4 then 'Unit'\n            when hierarchy_level = 5 then 'SubUnit'\n            when hierarchy_level = 6 then 'Assembly'\n            when hierarchy_level = 7 then 'SubAssembly'\n            when hierarchy_level >= 8 then 'Equipment'\n            else 'Unknown'\n        end as location_category,\n        -- Parent FLOC (remove last segment)\n        case\n            when instr(functional_location, '-') > 0 then\n                substring(functional_location, 1, \n                    length(functional_location) - length(substring_index(functional_location, '-', -1)) - 1)\n            else null\n        end as parent_floc\n    from `raw_ext_sap`.`asset_hierarchy`\n    where functional_location is not null and functional_location != ''\n)\n\nselect\n    -- Instance identification\n    concat('floc:', floc) as externalId,\n    'sylvamo_assets' as space,\n    \n    -- Core CogniteAsset properties (inherited from CogniteAsset)\n    coalesce(description, floc) as name,\n    concat('SAP Functional Location: ', floc, ' - ', coalesce(description, '')) as description,\n    floc as sourceId,\n    \n    -- Parent reference (for hierarchy) - Now enabled after initial node creation\n    case\n        when parent_floc is not null and parent_floc != '' then\n            node_reference('sylvamo_assets', concat('floc:', parent_floc))\n        else null\n    end as parent,\n    \n    -- Source system reference (disabled - requires source node to exist first)\n    -- node_reference('sylvamo_assets', 'source:SAP') as source,\n    null as source,\n    \n    -- Enterprise-specific properties (FunctionalLocation container)\n    floc as functionalLocationCode,\n    null as abcIndicator,\n    plant_code as plantCode,\n    plant_code as maintenancePlant,\n    location_category as locationCategory,\n    cast(hierarchy_level as int) as hierarchyLevel,\n    work_center_code as workCenterCode,\n    work_center_description as workCenterDescription\n    \nfrom hierarchy_data\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_CogniteAsset_from_SAP",
    "name": "[Core] Populate CogniteAsset from SAP FLOCs",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate CogniteAsset (Core View)\n   \n   Purpose:\n   - Creates CogniteAsset instances from SAP functional location data\n   - This is the CORE instance required for dual population\n   - Enterprise instances (FunctionalLocation) reference these\n   \n   Source: raw_ext_sap.asset_hierarchy (ingested from SAP)\n*/\n\nwith floc_data as (\n    -- Read from new SAP asset hierarchy table (raw_ext_sap)\n    -- This table combines both Eastover and Sumter FLOCs\n    select\n        functional_location as floc,\n        functional_location_description as description,\n        -- Extract plant code from FLOC (first 4 chars)\n        substring(functional_location, 1, 4) as plant_code\n    from `raw_ext_sap`.`asset_hierarchy`\n    where functional_location is not null and functional_location != ''\n),\n\nhierarchy_data as (\n    -- Build hierarchy with parent references\n    select\n        floc,\n        description,\n        plant_code,\n        -- Parent FLOC (remove last segment)\n        case\n            when instr(floc, '-') > 0 then\n                substring(floc, 1, length(floc) - length(substring_index(floc, '-', -1)) - 1)\n            else null\n        end as parent_floc\n    from floc_data\n)\n\nselect\n    -- Instance identification\n    concat('floc:', floc) as externalId,\n    'sylvamo_assets' as space,\n    \n    -- Core CogniteAsset properties\n    coalesce(description, floc) as name,\n    concat('SAP Functional Location: ', floc) as description,\n    floc as sourceId,\n    \n    -- Parent reference (for hierarchy)\n    case\n        when parent_floc is not null then\n            node_reference('sylvamo_assets', concat('floc:', parent_floc))\n        else null\n    end as parent,\n    \n    -- Source system reference\n    node_reference('sylvamo_assets', 'SAP') as source,\n    \n    -- Tags for search\n    array(plant_code, 'SAP', 'FLOC') as tags\n    \nfrom hierarchy_data\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_MaterialCostVariance_from_Fabric",
    "name": "[Products] Populate MaterialCostVariance from Fabric PPV",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate MaterialCostVariance from Fabric PPV Snapshot\n   \n   Purpose:\n   - Reads PPV financial data from RAW (extracted from Fabric Lakehouse)\n   - Creates MaterialCostVariance nodes linking to FunctionalLocation (Plant)\n   - Supports UC1: Material Cost Analysis\n   \n   Source RAW Table: raw_ext_fabric_ppv.ppv_snapshot\n   Destination: sylvamo_products.MaterialCostVariance view (v1)\n*/\n\nselect\n    -- Instance identification\n    concat('ppv:', cast(plant as string), ':', cast(material as string), ':', cast(current_fiscper_from as string)) as externalId,\n    'sylvamo_products' as space,\n    \n    -- MaterialCostVariance properties\n    cast(material as string) as material,\n    cast(material_type as string) as materialType,\n    cast(material_description as string) as materialDescription,\n    cast(plant as string) as plant,\n    \n    -- Link to FunctionalLocation (Plant)\n    node_reference('sylvamo_assets', concat('floc:', cast(plant as string))) as functionalLocation,\n    \n    -- Fiscal period\n    to_timestamp(concat(cast(current_fiscper_from as string), '01'), 'yyyyMMdd') as fiscalPeriod,\n    to_timestamp(concat(cast(current_fiscper_from as string), '01'), 'yyyyMMdd') as currentFiscalPeriodFrom,\n    to_timestamp(concat(cast(current_fiscper_to as string), '01'), 'yyyyMMdd') as currentFiscalPeriodTo,\n    to_timestamp(concat(cast(prior_fiscper_from as string), '01'), 'yyyyMMdd') as priorFiscalPeriodFrom,\n    to_timestamp(concat(cast(prior_fiscper_to as string), '01'), 'yyyyMMdd') as priorFiscalPeriodTo,\n    \n    -- Financial metrics - Current period\n    cast(current_quantity as double) as currentQuantity,\n    cast(current_standard_cost as double) as currentStandardCost,\n    cast(current_unit_cost as double) as currentUnitCost,\n    cast(current_ppv as double) as currentPPV,\n    \n    -- Financial metrics - Prior period\n    cast(prior_quantity as double) as priorQuantity,\n    cast(prior_standard_cost as double) as priorStandardCost,\n    cast(prior_unit_cost as double) as priorUnitCost,\n    cast(prior_ppv as double) as priorPPV,\n    \n    -- Accounting\n    cast(gl_account as string) as glAccount,\n    cast(units as string) as units,\n    cast(record_type as string) as recordType,\n    \n    -- Source system tracking\n    'Fabric' as sourceSystem\n    \nfrom `raw_ext_fabric_ppv`.`ppv_snapshot`\nwhere material is not null \n  and plant is not null\n  and current_fiscper_from is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "populate_SylvamoEvent_RollQuality",
    "name": "Populate Events - Roll Quality",
    "query": "-- Transformation: Populate SylvamoEvent from Roll Quality SharePoint data\n-- Creates quality events from roll quality inspection reports\n\nSELECT\n    -- Instance identifier (unique per event)\n    concat('roll_quality_', title) as externalId,\n    \n    -- Event classification\n    'Quality' as eventCategory,\n    'SharePoint' as eventSource,\n    \n    -- Quality test details\n    title as testId,\n    case \n        when was_the_roll_rejected = 'Yes' then 'Fail'\n        when was_the_roll_rejected = 'No' then 'Pass'\n        else 'Unknown'\n    end as testResult,\n    minutes_lost as resultValue,  -- Store minutes lost as the result value\n    \n    -- Product tracking\n    cast(null as STRING) as reelNumber,\n    title as rollNumber,\n    \n    -- Event details  \n    equipment as productionUnit,  -- Sheeter No.1, etc.\n    coalesce(defect, defect_non_damage) as material,  -- Defect code (damage or non-damage)\n    cast(null as DOUBLE) as varianceAmount,\n    \n    -- Location - extract plant from path (Sumter = 0770, Eastover = 0769)\n    case \n        when path like '%Sumter%' then '0770'\n        when path like '%Eastover%' then '0769'\n        else location\n    end as plantCode\n\nFROM \n    `raw_ext_sharepoint`.`roll_quality`\nWHERE \n    title is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Instances"
  },
  {
    "external_id": "populate_SylvamoFile_SharePoint",
    "name": "Populate Files - SharePoint",
    "query": "\nSELECT\n    concat('file_', externalId) as externalId,\n    source as sharePointSite,\n    -- Extract library from directory path\n    case \n        when directory like '%/root:%' then split_part(directory, '/root:', 1)\n        else directory\n    end as sharePointLibrary,\n    directory as sharePointPath,\n    -- Determine document type from mime type\n    case \n        when mimeType like '%spreadsheet%' or mimeType like '%excel%' then 'Spreadsheet'\n        when mimeType like '%document%' or mimeType like '%word%' then 'Document'\n        when mimeType like '%image%' then 'Image'\n        when mimeType like '%pdf%' then 'PDF'\n        else 'Other'\n    end as documentType,\n    -- Determine category from directory path\n    case \n        when directory like '%Packaging%' then 'Operations'\n        when directory like '%Sales%' then 'Sales'\n        when directory like '%Quality%' then 'Quality'\n        else 'General'\n    end as documentCategory,\n    -- Plant code based on name/path\n    case \n        when name like '%Sumter%' or directory like '%Sumter%' then '0770'\n        when name like '%Eastover%' or directory like '%Eastover%' then '0769'\n        else null\n    end as plantCode,\n    cast(null as STRING) as equipmentTag,\n    cast(null as STRING) as documentVersion,\n    cast(null as TIMESTAMP) as revisionDate\nFROM \n    _cdf.files\nWHERE \n    source = 'Sharepoint Online'\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Instances"
  },
  {
    "external_id": "populate_SylvamoTimeSeries_PI",
    "name": "Populate Time Series - PI Metadata",
    "query": "\n-- PI Server: s769pi03 (Eastover)\nSELECT\n    concat('ts_pi03_', key) as externalId,\n    key as piTagName,\n    's769pi03' as piServer,\n    cast(null as STRING) as engineeringUnits,\n    'Eastover' as processArea,\n    point_type as measurementType\nFROM \n    `raw_sylvamo_pilot`.`pi_s769pi03_metadata`\n\nUNION ALL\n\n-- PI Server: s769pi01 (Eastover)\nSELECT\n    concat('ts_pi01_', key) as externalId,\n    key as piTagName,\n    's769pi01' as piServer,\n    cast(null as STRING) as engineeringUnits,\n    'Eastover' as processArea,\n    point_type as measurementType\nFROM \n    `raw_sylvamo_pilot`.`pi_s769pi01_metadata`\n\nUNION ALL\n\n-- PI Server: s519pip1 (Sumter)\nSELECT\n    concat('ts_pip1_', key) as externalId,\n    key as piTagName,\n    's519pip1' as piServer,\n    cast(null as STRING) as engineeringUnits,\n    'Sumter' as processArea,\n    point_type as measurementType\nFROM \n    `raw_sylvamo_pilot`.`pi_s519pip1_metadata`\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Instances"
  },
  {
    "external_id": "tr-proficy-readings-timeseries",
    "name": "proficy-readings-timeseries",
    "query": "/* Create timeseries, one for each tag/sensor (Var_Id) from the Proficy data \n\twhere each datapoint will be a reading from that tag/sensor at that tiemstamp */\n\n-- --   Grouping by Var_Id\n-- --   Joining proficy data on tag_info table to get details on each Var_Id\n-- with GROUP_BY_VAR_ID as (\n--   select\n--   \tconcat(case max(e.`PU_Id`) \n--               when 4 then \"Paper Machine 1 - \" \n--               when 5 then \"Paper Machine 2 - \"\n--               else \"\" end, max(i.`Description`)) as name,\n--   \tconcat(\"proficy_readings_timeseries_\", e.`Var_Id`) as externalId,\n--   \tmax(i.`UOM`) as unit,\n--   \te.`Var_Id`,\n--   \tmax(e.`PU_Id`) as `PU_Id`\n--   from `raw_ext_sql_proficy`.`events_tests` as e\n--   \tleft join `raw_ext_sql_proficy`.`tag_info` as i\n--   \ton e.`Var_Id` == i.`Tag`\n--   where e.`Var_Id` is not NULL\n--   group by e.`Var_Id`\n-- )\n\n-- -- final select statement\n-- select\n--   name,\n--   externalId,\n--   map(\n--     \"Var ID\", cast(`Var_Id` as string),\n--     \"PU ID\", `PU_Id`\n--   ) as metadata,\n--   unit,\n--   dataset_id(\"ds_timeseries_Eastover\") as dataSetId,\n--   case unit\n--   \twhen \"mils\" then \"length:milliin\"\n--   \twhen \"GSM\" then \"areal_density:gm-per-m2\"\n--   end as unitExternalId\n-- from GROUP_BY_VAR_ID\n\n\n-- WORK IN PROGRESS TO:\n-- delete old timeseries, create new one in new data model\n-- deletion query\nselect *\nfrom cdf_data_models(\n  'sylvamo_mfg_core_schema',\n  'SylvamoMfgCore',\n  'v1',\n  'MfgTimeSeries'\n)\nwhere name like \"Paper Machine%\"",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Instances"
  },
  {
    "external_id": "tr_populate_LabTest_from_Proficy",
    "name": "[Raw Ext Analysis] Populate LabTest from Proficy",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate LabTest from Proficy Lab Tests\n   \n   Source RAW Tables: \n   - raw_ext_sql_proficy.events_tests (main)\n   - raw_ext_sql_proficy.tests (detailed results)\n   \n   Joins events_tests with tests on Event_Num/Event_Id and Var_Id\n*/\n\nselect\n    -- Instance identification\n    concat('lab:', \n        coalesce(cast(t.Test_Id as string), \n                 concat(cast(et.Event_Num as string), ':', cast(et.Var_Id as string)))\n    ) as externalId,\n    'sylvamo_raw_ext_analysis' as space,\n    \n    -- Test Identification\n    cast(t.Test_Id as bigint) as testId,\n    cast(coalesce(t.Event_Id, cast(et.Event_Num as bigint)) as bigint) as eventId,\n    cast(et.Event_Num as string) as eventNum,\n    cast(coalesce(t.Var_Id, et.Var_Id) as bigint) as varId,\n    \n    -- Test Results\n    cast(coalesce(t.Result, et.Result) as double) as result,\n    \n    -- Timing Information\n    to_timestamp(et.Productive_Start_Time) as productiveStartTime,\n    to_timestamp(et.Productive_End_Time) as productiveEndTime,\n    to_timestamp(t.Entry_On) as entryOn,\n    to_timestamp(t.Result_On) as resultOn,\n    \n    -- Process Unit\n    et.PU_Id as puId,\n    \n    -- Test Status\n    cast(t.Canceled as boolean) as canceled,\n    cast(t.Locked as boolean) as locked,\n    \n    -- User Information\n    t.Entry_By as entryBy,\n    t.Second_User_Id as secondUserId,\n    cast(t.Signature_Id as bigint) as signatureId,\n    cast(t.Comment_Id as bigint) as commentId,\n    cast(t.Array_Id as bigint) as arrayId\n    \nfrom `raw_ext_sql_proficy`.`events_tests` et\nleft join `raw_ext_sql_proficy`.`tests` t\n    on cast(t.Event_Id as string) = cast(et.Event_Num as string)\n    and t.Var_Id = et.Var_Id\nwhere et.Event_Num is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_Package_from_Fabric",
    "name": "[Products] Populate Package from Fabric PPR (CDM)",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate Package from Fabric PPR History (CDM-based)\n   \n   Purpose:\n   - Reads package production data from RAW (extracted from Fabric Lakehouse)\n   - Creates Package nodes extending CogniteAsset with parent Roll relationship\n   - Sets parent=parentRoll for hierarchical navigation\n   \n   Source RAW Table: raw_ext_fabric_ppr.ppr_hist_package\n   Destination: sylvamo_products.Package view (implements CogniteAsset v1)\n   \n   Note: A package can contain multiple rolls, but CDM parent is single.\n   We use the first roll or most representative roll as parent.\n*/\n\nselect\n    -- Instance identification\n    concat('package:', cast(PACK_PACKAGE_NUMBER as string)) as externalId,\n    'sylvamo_products' as space,\n    \n    -- Core CogniteAsset properties (inherited from CDM)\n    cast(PACK_PACKAGE_NUMBER as string) as name,\n    concat('Package: ', cast(PACK_PACKAGE_NUMBER as string)) as description,\n    cast(PACK_PACKAGE_NUMBER as string) as sourceId,\n    \n    -- CDM Hierarchy: parent=parentRoll (for production hierarchy)\n    -- Note: Package can have multiple rolls, but CDM parent is single\n    -- Use first roll from package (simplified - adjust based on actual data structure)\n    null as parent,  -- Will be set in a follow-up transformation if needed\n    \n    -- Source system reference\n    node_reference('sylvamo_assets', 'Fabric') as source,\n    \n    -- Package-specific properties (from Package container)\n    cast(PACK_PACKAGE_NUMBER as string) as packageNumber,\n    \n    -- Package metadata\n    cast(PACK_ASSEMBLED_DATE as int) as assembledDate,\n    case\n        when PACK_SHIP_DATE is not null and PACK_SHIP_DATE != '' then\n            cast(PACK_SHIP_DATE as int)  -- Simplified: use date as integer\n        else null\n    end as shippedDate,\n    cast(PACK_SHIPPING_LOCATION_CODE as string) as destination,\n    \n    -- Package contents\n    cast(PACK_NUMBER_ROLLS_IN_PACKAGE as int) as numberOfRolls,\n    cast(PACK_NOMINAL_WT as double) as totalWeight,\n    \n    -- Link to FunctionalLocation (Finishing/Shipping area)\n    -- Map based on shipping location or assembly location\n    case\n        when PACK_WEIGHED_LOCATION is not null then\n            node_reference('sylvamo_assets', concat('floc:', cast(PACK_WEIGHED_LOCATION as string)))\n        else null\n    end as functionalLocation,\n    \n    -- Source system tracking\n    'Fabric' as sourceSystem\n    \nfrom `raw_ext_fabric_ppr`.`ppr_hist_package`\nwhere PACK_PACKAGE_NUMBER is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_Reel_from_Fabric",
    "name": "[Products] Populate Reel from Fabric PPR (CDM)",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate Reel from Fabric PPR History (CDM-based)\n   \n   Purpose:\n   - Reads reel production data from RAW (extracted from Fabric Lakehouse)\n   - Creates Reel nodes extending CogniteAsset for hierarchical navigation\n   - Sets parent=null (root of production hierarchy)\n   \n   Source RAW Table: raw_ext_fabric_ppr.ppr_hist_reel\n   Destination: sylvamo_products.Reel view (implements CogniteAsset v1)\n*/\n\nselect\n    -- Instance identification\n    concat('reel:', cast(REEL_NUMBER as string)) as externalId,\n    'sylvamo_products' as space,\n    \n    -- Core CogniteAsset properties (inherited from CDM)\n    cast(REEL_NUMBER as string) as name,\n    concat('Paper Reel: ', cast(REEL_NUMBER as string)) as description,\n    cast(REEL_NUMBER as string) as sourceId,\n    \n    -- CDM Hierarchy: parent=null for root nodes\n    null as parent,\n    \n    -- Source system reference\n    node_reference('sylvamo_assets', 'Fabric') as source,\n    \n    -- Reel-specific properties (from Reel container)\n    cast(REEL_NUMBER as string) as reelNumber,\n    \n    -- Production metadata\n    cast(REEL_MANUFACTURED_DATE as int) as manufacturedDate,\n    cast(REEL_MANUFACTURING_PMP as string) as paperMachine,\n    cast(REEL_PRODUCT_CODE as string) as grade,\n    \n    -- Physical properties\n    cast(REEL_CALC_WEIGHT as double) as weight,\n    cast(REEL_REEL_WIDTH_WH as int) as width,\n    \n    -- Link to FunctionalLocation (Paper Machine equipment)\n    case\n        when substring(cast(REEL_NUMBER as string), 1, 5) in ('EM001') then\n            node_reference('sylvamo_assets', 'floc:0769-06-01-010')\n        when substring(cast(REEL_NUMBER as string), 1, 5) in ('EM002') then\n            node_reference('sylvamo_assets', 'floc:0769-06-01-020')\n        else null\n    end as functionalLocation,\n    \n    -- Source system tracking\n    'Fabric' as sourceSystem\n    \nfrom `raw_ext_fabric_ppr`.`ppr_hist_reel`\nwhere REEL_NUMBER is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_Roll_from_Fabric",
    "name": "[Products] Populate Roll from Fabric PPR (CDM)",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate Roll from Fabric PPR History (CDM-based)\n   \n   Purpose:\n   - Reads roll production data from RAW (extracted from Fabric Lakehouse)\n   - Creates Roll nodes extending CogniteAsset with parent Reel relationship\n   - Sets parent=parentReel for hierarchical navigation\n   \n   Source RAW Table: raw_ext_fabric_ppr.ppr_hist_roll\n   Destination: sylvamo_products.Roll view (implements CogniteAsset v1)\n*/\n\nselect\n    -- Instance identification\n    concat('roll:', cast(ROLL_NUMBER as string)) as externalId,\n    'sylvamo_products' as space,\n    \n    -- Core CogniteAsset properties (inherited from CDM)\n    cast(ROLL_NUMBER as string) as name,\n    concat('Paper Roll: ', cast(ROLL_NUMBER as string)) as description,\n    cast(ROLL_NUMBER as string) as sourceId,\n    \n    -- CDM Hierarchy: parent=parentReel (for production hierarchy)\n    case\n        when ROLL_PARENT_REEL1 is not null \n             and ROLL_PARENT_REEL1 not like '%DUMMY%' \n        then\n            node_reference('sylvamo_products', concat('reel:', cast(ROLL_PARENT_REEL1 as string)))\n        else null\n    end as parent,\n    \n    -- Source system reference\n    node_reference('sylvamo_assets', 'Fabric') as source,\n    \n    -- Roll-specific properties (from Roll container)\n    cast(ROLL_NUMBER as string) as rollNumber,\n    cast(ROLL_PARENT_REEL1 as string) as reelNumber,  -- Text reference for lookup\n    \n    -- Production metadata\n    cast(ROLL_MANUFACTURED_DATE as int) as manufacturedDate,\n    cast(ROLL_REWINDER_NUMBER as string) as winder,\n    cast(ROLL_PRODUCT_CODE as string) as grade,\n    \n    -- Package relationship (text reference)\n    cast(ROLL_PACK_PACKAGE_NUMBER as string) as packageNumber,\n    \n    -- Physical properties\n    cast(ROLL_CALC_WEIGHT as double) as weight,\n    cast(ROLL_REEL_WIDTH_WH as int) as width,\n    \n    -- Link to FunctionalLocation (Winder equipment)\n    -- Map winder to FLOC (simplified - adjust based on actual mapping)\n    case\n        when ROLL_REWINDER_NUMBER is not null then\n            node_reference('sylvamo_assets', concat('floc:', cast(ROLL_REWINDER_NUMBER as string)))\n        else null\n    end as functionalLocation,\n    \n    -- Source system tracking\n    'Fabric' as sourceSystem\n    \nfrom `raw_ext_fabric_ppr`.`ppr_hist_roll`\nwhere ROLL_NUMBER is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_FunctionalLocation_v6",
    "name": "[Enterprise v6] Populate FunctionalLocation from SAP",
    "query": "\nSELECT\n    concat('floc:', functional_location) as externalId,\n    'enterprise_model' as space,\n    functional_location_description as name,\n    concat('SAP Functional Location: ', functional_location) as description,\n    cast(functional_location as STRING) as sourceId,\n    node_reference('enterprise_model', 'source:sap_pm') as source,\n    cast(null as STRING) as plantCode,\n    cast(functional_location as STRING) as functionalLocationCode,\n    cast(null as STRING) as maintenancePlant,\n    cast(null as STRING) as costCenter,\n    cast(null as STRING) as objectType,\n    cast(null as STRING) as locationCategory,\n    cast(hierarchy_level as STRING) as hierarchyLevel,\n    cast(null as STRING) as abcIndicator,\n    work_center_code as workCenterCode,\n    work_center_description as workCenterDescription,\n    cast(null as STRING) as UUID\nFROM `raw_sylvamo_sap`.`asset_hierarchy`\nWHERE functional_location is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_SylvamoTimeSeries_v6",
    "name": "[Enterprise v6] Populate SylvamoTimeSeries from PI",
    "query": "\nSELECT\n    concat('ts:', key) as externalId,\n    'enterprise_model' as space,\n    key as name,\n    'PI Tag' as description,\n    key as sourceId,\n    node_reference('enterprise_model', 'source:pi_historian') as source,\n    false as isStep,\n    'numeric' as type,\n    key as piTagName,\n    's769pi03' as piServer,\n    cast(null as STRING) as engineeringUnits,\n    'Eastover' as processArea,\n    cast(point_type as STRING) as measurementType,\n    cast(null as STRING) as UUID\nFROM `raw_sylvamo_pi`.`s769pi03_metadata`\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_SylvamoFile_v6",
    "name": "[Enterprise v6] Populate SylvamoFile from SharePoint",
    "query": "\nSELECT\n    concat('file:', key) as externalId,\n    'enterprise_model' as space,\n    title as name,\n    concat('Quality Report: ', title) as description,\n    key as sourceId,\n    node_reference('enterprise_model', 'source:sharepoint') as source,\n    'SharePoint' as sharePointSite,\n    'Quality Reports' as sharePointLibrary,\n    path as sharePointPath,\n    item_type as documentType,\n    'Quality' as documentCategory,\n    location as plantCode,\n    equipment as equipmentTag,\n    cast(null as STRING) as documentVersion,\n    date as revisionDate,\n    cast(null as STRING) as UUID\nFROM `raw_sylvamo_sharepoint`.`documents`\nWHERE title is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_SylvamoEvent_v6",
    "name": "[Enterprise v6] Populate SylvamoEvent from Proficy",
    "query": "\nSELECT\n    concat('event:', row_key) as externalId,\n    'enterprise_model' as space,\n    concat('Lab Test: ', Var_Id, ' - Event:', event_id) as name,\n    'Proficy lab test' as description,\n    cast(row_key as STRING) as sourceId,\n    to_timestamp(Productive_Start_Time) as startTime,\n    to_timestamp(Productive_End_Time) as endTime,\n    node_reference('enterprise_model', 'source:proficy') as source,\n    'LabTest' as eventCategory,\n    'Proficy' as eventSource,\n    case when PU_Id = 4 then 'PM1' when PU_Id = 5 then 'PM2' else cast(PU_Id as STRING) end as productionUnit,\n    cast(Var_Id as STRING) as testId,\n    cast(null as STRING) as testResult,\n    cast(Result as STRING) as resultValue,\n    Event_Num as reelNumber,\n    cast(null as STRING) as rollNumber,\n    cast(null as STRING) as material,\n    '0769' as plantCode,\n    cast(null as STRING) as varianceAmount,\n    cast(null as STRING) as UUID\nFROM `raw_sylvamo_proficy`.`events_tests`\nWHERE row_key is not null\nLIMIT 5000\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_isa_batch_from_reel",
    "name": "[ISA] Populate Batch from Reel",
    "query": "\n-- Transformation: Populate ISA Batch from Reel data\nSELECT\n    concat('batch:', substring(cast(REEL_MANUFACTURED_DATE as STRING), 1, 4), ':', REEL_NUMBER) as externalId,\n    'sp_sylvamo_isa_instance' as space,\n    \n    -- ISA-88 Batch properties\n    concat('batch:', substring(cast(REEL_MANUFACTURED_DATE as STRING), 1, 4), ':', REEL_NUMBER) as batch_id,\n    REEL_NUMBER as batch_number,\n    'Complete' as batch_state,\n    cast(REEL_CRANE_WEIGHT as DOUBLE) as batch_size,\n    'kg' as batch_size_unit,\n    \n    -- Sylvamo extensions\n    case \n        when REEL_NUMBER like 'EM001%' then 'PM1'\n        when REEL_NUMBER like 'EM002%' then 'PM2'\n        else 'Unknown'\n    end as paper_machine,\n    REEL_PRODUCT_CODE as grade,\n    cast(trim(REEL_AVERAGE_BASIS_WEIGHT) as DOUBLE) as basis_weight,\n    cast(trim(REEL_AVERAGE_CALIPER) as DOUBLE) as caliper,\n    cast(trim(REEL_AVERAGE_MOISTURE) as DOUBLE) as moisture,\n    REEL_TURNUP_TIME as reel_turnup_time,\n    cast(REEL_RUN_TIME_IN_MIN as INT) as reel_run_time_min,\n    \n    -- Relations\n    node_reference('sp_sylvamo_isa_instance', 'site:eastover') as site,\n    case \n        when REEL_NUMBER like 'EM001%' then node_reference('sp_sylvamo_isa_instance', 'unit:pm1')\n        when REEL_NUMBER like 'EM002%' then node_reference('sp_sylvamo_isa_instance', 'unit:pm2')\n        else null\n    end as unit\n\nFROM `raw_sylvamo_fabric`.`hist_reel`\nWHERE REEL_NUMBER is not null\nLIMIT 500\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_isa_qualityresult_from_proficy",
    "name": "[ISA] Populate QualityResult from Proficy",
    "query": "\n-- Transformation: Populate ISA QualityResult from Proficy LabTest\nSELECT\n    concat('qr:', row_key) as externalId,\n    'sp_sylvamo_isa_instance' as space,\n    \n    -- ISA-88 QualityResult properties\n    concat('qr:', row_key) as result_id,\n    cast(Var_Id as STRING) as test_type,\n    Result as result_value,\n    cast(null as STRING) as result_unit,\n    case when Result is not null then 'Recorded' else 'Pending' end as result_status,\n    to_timestamp(Productive_Start_Time) as test_timestamp,\n    \n    -- CogniteSchedulable\n    to_timestamp(Productive_Start_Time) as startTime,\n    to_timestamp(Productive_End_Time) as endTime,\n    \n    -- Sylvamo extensions\n    Var_Id as var_id,\n    PU_Id as pu_id,\n    event_id as event_num\n\nFROM `raw_sylvamo_proficy`.`events_tests`\nWHERE row_key is not null\nLIMIT 5000\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_isa_timeseries_from_pi",
    "name": "[ISA] Populate ISATimeSeries from PI",
    "query": "\n-- Transformation: Populate ISATimeSeries from PI metadata\nSELECT\n    concat('isats:', key) as externalId,\n    'sp_sylvamo_isa_instance' as space,\n    \n    -- ISATimeSeries properties\n    key as tag_name,\n    concat('PI Tag: ', key) as tag_description,\n    cast(null as STRING) as engineering_units,\n    's769pi03' as pi_server,\n    \n    -- CogniteTimeSeries required\n    false as isStep,\n    'numeric' as type,\n    \n    -- Relation to Unit (assuming all are from PM1/PM2)\n    node_reference('sp_sylvamo_isa_instance', 'unit:pm1') as unit\n\nFROM `raw_sylvamo_pi`.`s769pi03_metadata`\nWHERE key is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_Reel_from_Fabric_v3",
    "name": "[Products] Populate Reel from Fabric PPR (ISA-95 Aligned)",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate Reel from Fabric PPR History\n   Version: v3 - ISA-95/ISA-88 Aligned\n   \n   Purpose:\n   - Reads reel production data from RAW (extracted from Fabric Lakehouse)\n   - Creates Reel nodes with ISA-88 Batch properties\n   - Links to ISA-95 hierarchy (Site, Unit, ProductDefinition)\n   \n   Source RAW Table: raw_ext_fabric_ppr.ppr_hist_reel\n   \n   ISA-88 Batch Mapping:\n   - Reel = Batch (a production run on the paper machine)\n   - batchNumber = reelNumber\n   - startTime = manufacturedDate + turnupTime\n   - endTime = startTime + runTimeMinutes\n*/\n\nselect\n    -- ============================================================\n    -- Instance identification\n    -- NOTE: Include year in externalId for uniqueness across years\n    -- ============================================================\n    concat(\n        'reel:', \n        substring(cast(reel_manufactured_date as string), 1, 4), \n        ':', \n        coalesce(cast(reel_number as string), key)\n    ) as externalId,\n    'sylvamo_products' as space,\n    \n    -- ============================================================\n    -- Core Reel identification\n    -- ============================================================\n    cast(reel_number as string) as reelNumber,\n    \n    -- ============================================================\n    -- ISA-88 Batch Properties (NEW in v3)\n    -- ============================================================\n    cast(reel_number as string) as batchNumber,\n    'Complete' as batchState,\n    \n    -- Calculate startTime: manufacturedDate + turnupTime\n    -- Note: turnupTime format needs validation\n    to_timestamp(\n        concat(\n            cast(reel_manufactured_date as string), \n            lpad(cast(coalesce(reel_turnup_time, '000000') as string), 6, '0')\n        ), \n        'yyyyMMddHHmmss'\n    ) as startTime,\n    \n    -- Calculate endTime: startTime + runTimeMinutes\n    -- Using timestamp arithmetic\n    timestampadd(\n        MINUTE,\n        coalesce(cast(reel_run_time_in_min as int), 0),\n        to_timestamp(\n            concat(\n                cast(reel_manufactured_date as string), \n                lpad(cast(coalesce(reel_turnup_time, '000000') as string), 6, '0')\n            ), \n            'yyyyMMddHHmmss'\n        )\n    ) as endTime,\n    \n    -- ============================================================\n    -- Production info (legacy fields preserved)\n    -- ============================================================\n    -- DEPRECATED: Use 'unit' relation instead\n    case \n        when substring(cast(reel_number as string), 3, 3) = '001' then 'PM1'\n        when substring(cast(reel_number as string), 3, 3) = '002' then 'PM2'\n        else substring(cast(reel_number as string), 1, 5)\n    end as paperMachine,\n    \n    to_timestamp(concat(cast(reel_manufactured_date as string), '000000'), 'yyyyMMddHHmmss') as manufacturedDate,\n    cast(reel_manufactured_crew as string) as manufacturedCrew,\n    cast(reel_manufactured_shift as string) as manufacturedShift,\n    cast(reel_turnup_time as string) as turnupTime,\n    cast(reel_run_time_in_min as int) as runTimeMinutes,\n    \n    -- ============================================================\n    -- Quality properties\n    -- ============================================================\n    cast(reel_average_basis_weight as double) as averageBasisWeight,\n    cast(reel_average_caliper as double) as averageCaliper,\n    cast(reel_average_moisture as double) as averageMoisture,\n    \n    -- ============================================================\n    -- Production metrics\n    -- ============================================================\n    cast(reel_calc_weight as double) as grossWeight,\n    cast(reel_finished_weight as int) as netWeight,\n    cast(reel_machine_speed as int) as machineSpeed,\n    cast(reel_trim_loss as int) as trimLoss,\n    \n    -- ============================================================\n    -- Product info\n    -- ============================================================\n    cast(reel_product_code as string) as productCode,\n    \n    -- ============================================================\n    -- ISA-95 Relations (NEW in v3)\n    -- ============================================================\n    -- Link to Unit (PM1 or PM2)\n    case\n        when substring(cast(reel_number as string), 3, 3) = '001' then\n            node_reference('sylvamo_isa', 'unit:pm1')\n        when substring(cast(reel_number as string), 3, 3) = '002' then\n            node_reference('sylvamo_isa', 'unit:pm2')\n        else null\n    end as unit,\n    \n    -- Link to Site (Eastover for all production reels)\n    node_reference('sylvamo_isa', 'site:eastover') as site,\n    \n    -- Link to ProductDefinition (via product_code mapping)\n    -- Map product codes to ProductDefinition externalIds\n    -- Product codes like 'W' need mapping - for now, set to null if no match\n    -- TODO: Create proper mapping table for product codes to ProductDefinition IDs\n    null as productDefinition,\n    \n    -- ============================================================\n    -- Metadata\n    -- ============================================================\n    to_timestamp(ingest_date) as ingestDate,\n    'Fabric' as sourceSystem\n    \nfrom `raw_ext_fabric_ppr`.`ppr_hist_reel`\nwhere reel_number is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_Roll_from_Fabric_v3",
    "name": "[Products] Populate Roll from Fabric PPR (ISA-95 Aligned)",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate Roll from Fabric PPR History\n   Version: v3 - ISA-95 Aligned\n   \n   Purpose:\n   - Reads roll production data from RAW (extracted from Fabric Lakehouse)\n   - Creates Roll nodes with ISA-95 MaterialLot properties\n   - Links to parent Batch (Reel) and ISA-95 hierarchy\n   \n   Source RAW Table: raw_ext_fabric_ppr.ppr_hist_roll\n   \n   ISA-95 MaterialLot Mapping:\n   - Roll = MaterialLot (finished product from winder)\n   - lotNumber = rollNumber\n   - batch = parentReel (ISA-88 terminology)\n*/\n\nselect\n    -- ============================================================\n    -- Instance identification\n    -- NOTE: Include year from manufactured_date for uniqueness\n    -- ============================================================\n    concat(\n        'roll:',\n        substring(cast(roll_manufactured_date as string), 1, 4),\n        ':',\n        coalesce(cast(roll_number as string), key)\n    ) as externalId,\n    'sylvamo_products' as space,\n    \n    -- ============================================================\n    -- Core Roll identification\n    -- ============================================================\n    cast(roll_number as string) as rollNumber,\n    \n    -- Normalized roll number: strip EM/ZI prefix for SharePoint matching\n    case \n        when cast(roll_number as string) like 'EM%' then substring(cast(roll_number as string), 3)\n        when cast(roll_number as string) like 'ZI%' then substring(cast(roll_number as string), 3)\n        else cast(roll_number as string)\n    end as normalizedRollNumber,\n    \n    -- ============================================================\n    -- ISA-95 MaterialLot Properties (NEW in v3)\n    -- ============================================================\n    cast(roll_number as string) as lotNumber,\n    'Finished' as lotType,\n    to_timestamp(concat(cast(roll_manufactured_date as string), '000000'), 'yyyyMMddHHmmss') as manufactureDate,\n    \n    -- ============================================================\n    -- Parent references\n    -- ============================================================\n    -- Legacy: text-based reference\n    cast(roll_parent_reel1 as string) as parentReelNumber,\n    \n    -- NEW: Direct relation to parent Reel (with year for uniqueness)\n    -- Extract year from roll_manufactured_date\n    case \n        when roll_parent_reel1 is not null \n             and roll_parent_reel1 not like '%DUMMY%' \n        then\n            node_reference(\n                'sylvamo_products', \n                concat(\n                    'reel:',\n                    substring(cast(roll_manufactured_date as string), 1, 4),\n                    ':',\n                    cast(roll_parent_reel1 as string)\n                )\n            )\n        else null\n    end as parentReel,\n    \n    -- ISA-88 'batch' relation (alias of parentReel for ISA compatibility)\n    case \n        when roll_parent_reel1 is not null \n             and roll_parent_reel1 not like '%DUMMY%' \n        then\n            node_reference(\n                'sylvamo_products', \n                concat(\n                    'reel:',\n                    substring(cast(roll_manufactured_date as string), 1, 4),\n                    ':',\n                    cast(roll_parent_reel1 as string)\n                )\n            )\n        else null\n    end as batch,\n    \n    -- ============================================================\n    -- Production info\n    -- ============================================================\n    cast(roll_paper_machine as string) as paperMachine,\n    cast(roll_manufactured_date as int) as manufacturedDateInt,\n    cast(roll_crew as string) as crew,\n    cast(roll_shift as string) as shift,\n    \n    -- ============================================================\n    -- Quality properties (inherited from parent Reel, but stored for convenience)\n    -- ============================================================\n    cast(roll_basis_weight as double) as basisWeight,\n    cast(roll_caliper as double) as caliper,\n    cast(roll_moisture as double) as moisture,\n    \n    -- ============================================================\n    -- Physical properties\n    -- ============================================================\n    cast(roll_current_diameter as double) as diameter,\n    cast(roll_width_wh as int) as width,\n    cast(roll_current_weight as int) as weight,\n    \n    -- ============================================================\n    -- Position info\n    -- ============================================================\n    cast(roll_set_number as string) as rollSetNumber,\n    cast(roll_set_position as string) as position,\n    cast(roll_reel_set_number as int) as sequence,\n    \n    -- ============================================================\n    -- Origin\n    -- ============================================================\n    case \n        when cast(roll_number as string) like 'EM%' then 'EAST_OVER_MILL'\n        when cast(roll_number as string) like 'ZI%' then 'THIRD_PARTY'\n        else 'UNKNOWN'\n    end as origin,\n    \n    -- ============================================================\n    -- ISA-95 Relations (NEW in v3)\n    -- ============================================================\n    -- Link to Site (Eastover for EM rolls, could be different for ZI)\n    case \n        when cast(roll_number as string) like 'EM%' then\n            node_reference('sylvamo_isa', 'site:eastover')\n        else null\n    end as site,\n    \n    -- Link to Unit (Winder - the unit that produced the roll)\n    node_reference('sylvamo_isa', 'unit:winder1') as unit,\n    \n    -- Link to ProductDefinition (inherited from parent Reel via product mapping)\n    -- Note: For full implementation, join with Reel to get productDefinition\n    cast(null as string) as productDefinition,\n    \n    -- ============================================================\n    -- Status\n    -- ============================================================\n    'Available' as status,\n    \n    -- ============================================================\n    -- Metadata\n    -- ============================================================\n    to_timestamp(ingest_date) as ingestDate\n    \nfrom `raw_ext_fabric_ppr`.`ppr_hist_roll`\nwhere roll_number is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_ProductDefinition",
    "name": "[ISA] Populate ProductDefinition Reference Data",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate ProductDefinition Reference Data\n   \n   Purpose:\n   - Creates ProductDefinition nodes for paper grades\n   - Defines specifications for each paper type\n   \n   Product Types:\n   - Bond: Standard office paper\n   - Offset: Commercial printing paper\n   - Cover: Book covers and cards\n   - Text: Publications\n*/\n\n-- Bond 20lb\nselect\n    'productdef:bond-20lb' as externalId,\n    'sylvamo_isa' as space,\n    'BOND-20LB' as productId,\n    'Bond 20lb' as name,\n    'Standard 20lb bond paper for office use, 75 brightness' as description,\n    'Bond' as productType,\n    'Office Papers' as productFamily,\n    20.0 as basisWeight,\n    'lb' as basisWeightUnit,\n    75.0 as brightness,\n    3.5 as caliper,\n    'MILS' as caliperUnit,\n    88.0 as opacity,\n    4.5 as moistureTarget,\n    3.5 as moistureMin,\n    5.5 as moistureMax,\n    true as isActive,\n    'MAT-BOND-20' as sapMaterialCode\n\nunion all\n\n-- Bond 24lb\nselect\n    'productdef:bond-24lb' as externalId,\n    'sylvamo_isa' as space,\n    'BOND-24LB' as productId,\n    'Bond 24lb' as name,\n    'Premium 24lb bond paper for office use, 75 brightness' as description,\n    'Bond' as productType,\n    'Office Papers' as productFamily,\n    24.0 as basisWeight,\n    'lb' as basisWeightUnit,\n    75.0 as brightness,\n    4.2 as caliper,\n    'MILS' as caliperUnit,\n    90.0 as opacity,\n    4.5 as moistureTarget,\n    3.5 as moistureMin,\n    5.5 as moistureMax,\n    true as isActive,\n    'MAT-BOND-24' as sapMaterialCode\n\nunion all\n\n-- Offset 50lb\nselect\n    'productdef:offset-50lb' as externalId,\n    'sylvamo_isa' as space,\n    'OFFSET-50LB' as productId,\n    'Offset 50lb' as name,\n    '50lb offset paper for commercial printing, 80 brightness' as description,\n    'Offset' as productType,\n    'Printing Papers' as productFamily,\n    50.0 as basisWeight,\n    'lb' as basisWeightUnit,\n    80.0 as brightness,\n    4.0 as caliper,\n    'MILS' as caliperUnit,\n    92.0 as opacity,\n    5.0 as moistureTarget,\n    4.0 as moistureMin,\n    6.0 as moistureMax,\n    true as isActive,\n    'MAT-OFF-50' as sapMaterialCode\n\nunion all\n\n-- Offset 60lb\nselect\n    'productdef:offset-60lb' as externalId,\n    'sylvamo_isa' as space,\n    'OFFSET-60LB' as productId,\n    'Offset 60lb' as name,\n    '60lb offset paper for commercial printing, 80 brightness' as description,\n    'Offset' as productType,\n    'Printing Papers' as productFamily,\n    60.0 as basisWeight,\n    'lb' as basisWeightUnit,\n    80.0 as brightness,\n    4.8 as caliper,\n    'MILS' as caliperUnit,\n    94.0 as opacity,\n    5.0 as moistureTarget,\n    4.0 as moistureMin,\n    6.0 as moistureMax,\n    true as isActive,\n    'MAT-OFF-60' as sapMaterialCode\n\nunion all\n\n-- Cover 65lb\nselect\n    'productdef:cover-65lb' as externalId,\n    'sylvamo_isa' as space,\n    'COVER-65LB' as productId,\n    'Cover 65lb' as name,\n    '65lb cover stock for cards and book covers, 88 brightness' as description,\n    'Cover' as productType,\n    'Specialty Papers' as productFamily,\n    65.0 as basisWeight,\n    'lb' as basisWeightUnit,\n    88.0 as brightness,\n    7.0 as caliper,\n    'MILS' as caliperUnit,\n    96.0 as opacity,\n    5.5 as moistureTarget,\n    4.5 as moistureMin,\n    6.5 as moistureMax,\n    true as isActive,\n    'MAT-COV-65' as sapMaterialCode\n\nunion all\n\n-- Text 70lb\nselect\n    'productdef:text-70lb' as externalId,\n    'sylvamo_isa' as space,\n    'TEXT-70LB' as productId,\n    'Text 70lb' as name,\n    '70lb text paper for publications, 90 brightness' as description,\n    'Text' as productType,\n    'Publishing Papers' as productFamily,\n    70.0 as basisWeight,\n    'lb' as basisWeightUnit,\n    90.0 as brightness,\n    5.2 as caliper,\n    'MILS' as caliperUnit,\n    95.0 as opacity,\n    5.0 as moistureTarget,\n    4.0 as moistureMin,\n    6.0 as moistureMax,\n    true as isActive,\n    'MAT-TXT-70' as sapMaterialCode\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_QualityResult",
    "name": "[ISA] Populate QualityResult Instances",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate QualityResult Instances\n   \n   Purpose:\n   - Creates QualityResult nodes for ISA-95 quality tracking\n   - Links quality results to Reels (Batches) and Rolls (MaterialLots)\n   - Supports batch-level and lot-level quality analysis\n   \n   Phase 3: Sample quality results linked to sample Reel external IDs\n   \n   Note: In production, this would query from:\n   - Proficy lab test data\n   - SharePoint quality reports\n   - Scanner quality data\n*/\n\n-- Generate sample quality test results using UNION ALL\n-- Create 20 sample quality results linked to sample Reel external IDs\nwith sample_data as (\n    select 1 as test_num, 'reel:2023:EM0010126020' as reel_external_id, 'EM0010126020' as reel_number, 'Caliper' as test_name, 'Lab' as test_method, 'Dimensional' as test_type\n    union all select 2, 'reel:2023:EM0010126020', 'EM0010126020', 'Moisture', 'Scanner', 'Physical'\n    union all select 3, 'reel:2023:EM0010126020', 'EM0010126020', 'Basis Weight', 'Inspection', 'Physical'\n    union all select 4, 'reel:2023:EM0010126020', 'EM0010126020', 'Brightness', 'Lab', 'Physical'\n    union all select 5, 'reel:2022:EM0011230018', 'EM0011230018', 'Caliper', 'Scanner', 'Dimensional'\n    union all select 6, 'reel:2022:EM0011230018', 'EM0011230018', 'Moisture', 'Inspection', 'Physical'\n    union all select 7, 'reel:2023:EM0010312012', 'EM0010312012', 'Basis Weight', 'Lab', 'Physical'\n    union all select 8, 'reel:2023:EM0010312012', 'EM0010312012', 'Brightness', 'Scanner', 'Physical'\n    union all select 9, 'reel:2023:EM0010109032', 'EM0010109032', 'Caliper', 'Inspection', 'Dimensional'\n    union all select 10, 'reel:2023:EM0010109032', 'EM0010109032', 'Moisture', 'Lab', 'Physical'\n    union all select 11, 'reel:2023:EM0010305020', 'EM0010305020', 'Basis Weight', 'Scanner', 'Physical'\n    union all select 12, 'reel:2023:EM0010305020', 'EM0010305020', 'Brightness', 'Inspection', 'Physical'\n    union all select 13, 'reel:2023:EM0010126020', 'EM0010126020', 'Caliper', 'Lab', 'Dimensional'\n    union all select 14, 'reel:2022:EM0011230018', 'EM0011230018', 'Moisture', 'Scanner', 'Physical'\n    union all select 15, 'reel:2023:EM0010312012', 'EM0010312012', 'Basis Weight', 'Inspection', 'Physical'\n    union all select 16, 'reel:2023:EM0010109032', 'EM0010109032', 'Brightness', 'Lab', 'Physical'\n    union all select 17, 'reel:2023:EM0010305020', 'EM0010305020', 'Caliper', 'Scanner', 'Dimensional'\n    union all select 18, 'reel:2023:EM0010126020', 'EM0010126020', 'Moisture', 'Inspection', 'Physical'\n    union all select 19, 'reel:2022:EM0011230018', 'EM0011230018', 'Basis Weight', 'Lab', 'Physical'\n    union all select 20, 'reel:2023:EM0010312012', 'EM0010312012', 'Brightness', 'Scanner', 'Physical'\n)\n\nselect\n    -- ============================================================\n    -- Core Identification\n    -- ============================================================\n    concat('qualityresult:', sd.reel_number, '-', sd.test_name, '-', cast(sd.test_num as string)) as externalId,\n    'sylvamo_isa' as space,\n    concat(sd.reel_number, '-', sd.test_name, '-', cast(sd.test_num as string)) as resultId,\n    \n    -- ============================================================\n    -- CogniteDescribable (required by view)\n    -- ============================================================\n    concat(sd.test_name, ' Test Result for Reel ', sd.reel_number) as name,\n    concat('Quality test result: ', sd.test_name, ' (', sd.test_method, ') for reel ', sd.reel_number, '. Test type: ', sd.test_type) as description,\n    \n    -- ============================================================\n    -- Test Information\n    -- ============================================================\n    sd.test_name as testName,\n    sd.test_method as testMethod,\n    sd.test_type as testType,\n    \n    -- ============================================================\n    -- Result Values (sample data)\n    -- ============================================================\n    case sd.test_name\n        when 'Caliper' then 4.5 + (random() * 1.0)  -- 4.5-5.5 MILS\n        when 'Moisture' then 5.0 + (random() * 2.0)  -- 5.0-7.0%\n        when 'Basis Weight' then 60.0 + (random() * 10.0)  -- 60-70 lbs\n        else 85.0 + (random() * 5.0)  -- Brightness: 85-90\n    end as resultValue,\n    \n    null as resultText,  -- For numeric results\n    \n    -- Test date: current timestamp\n    current_timestamp() as resultDate,\n    \n    case sd.test_name\n        when 'Caliper' then 'MILS'\n        when 'Moisture' then '%'\n        when 'Basis Weight' then 'lbs'\n        else 'ISO'\n    end as unitOfMeasure,\n    \n    -- ============================================================\n    -- Specification Comparison\n    -- ============================================================\n    case sd.test_name\n        when 'Caliper' then 4.0\n        when 'Moisture' then 4.0\n        when 'Basis Weight' then 55.0\n        else 80.0\n    end as specMin,\n    \n    case sd.test_name\n        when 'Caliper' then 6.0\n        when 'Moisture' then 8.0\n        when 'Basis Weight' then 75.0\n        else 95.0\n    end as specMax,\n    \n    case sd.test_name\n        when 'Caliper' then 5.0\n        when 'Moisture' then 6.0\n        when 'Basis Weight' then 65.0\n        else 87.5\n    end as specTarget,\n    \n    -- isInSpec: Check if resultValue is within specMin-specMax\n    case sd.test_name\n        when 'Caliper' then \n            (4.5 + (random() * 1.0)) between 4.0 and 6.0\n        when 'Moisture' then \n            (5.0 + (random() * 2.0)) between 4.0 and 8.0\n        when 'Basis Weight' then \n            (60.0 + (random() * 10.0)) between 55.0 and 75.0\n        else \n            (85.0 + (random() * 5.0)) between 80.0 and 95.0\n    end as isInSpec,\n    \n    -- deviation: resultValue - specTarget (calculated in transformation)\n    case sd.test_name\n        when 'Caliper' then (4.5 + (random() * 1.0)) - 5.0\n        when 'Moisture' then (5.0 + (random() * 2.0)) - 6.0\n        when 'Basis Weight' then (60.0 + (random() * 10.0)) - 65.0\n        else (85.0 + (random() * 5.0)) - 87.5\n    end as deviation,\n    \n    -- ============================================================\n    -- ISA-95 Relations (stored as text external IDs)\n    -- ============================================================\n    -- Link to Batch (Reel) - stored as external ID string\n    sd.reel_external_id as batch,\n    \n    -- MaterialLot (Roll) - null for now (would link to specific Roll if available)\n    null as materialLot,\n    \n    -- ============================================================\n    -- Source Tracking\n    -- ============================================================\n    'Sample' as sourceSystem,\n    concat('sample-', cast(sd.test_num as string)) as sourceId,\n    \n    -- ============================================================\n    -- Proficy-specific fields (sample values)\n    -- ============================================================\n    case sd.test_name\n        when 'Caliper' then 101\n        when 'Moisture' then 102\n        when 'Basis Weight' then 103\n        else 104\n    end as varId,\n    \n    -- puId: 4=PM1, 5=PM2 (sample: assume PM1 for now)\n    4 as puId,\n    \n    -- testEventId: Group tests by reel (use test_num)\n    sd.test_num as testEventId,\n    \n    -- ============================================================\n    -- Metadata\n    -- ============================================================\n    'Complete' as status,\n    concat('Sample quality test for reel ', sd.reel_number) as notes,\n    current_timestamp() as createdDate\n    \nfrom sample_data sd\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_QualityTestResult",
    "name": "[ISA] Populate QualityTestResult Instances",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate QualityTestResult Instances\n   \n   Purpose:\n   - Creates QualityTestResult nodes for ISA-95 quality tracking\n   - Links quality results to Reels (Batches) and Rolls (MaterialLots)\n   - Supports batch-level and lot-level quality analysis\n   \n   Phase 3: Sample quality results linked to sample Reel external IDs\n   \n   Note: In production, this would query from:\n   - Proficy lab test data\n   - SharePoint quality reports\n   - Scanner quality data\n*/\n\n-- Generate sample quality test results using UNION ALL\n-- Create 20 sample quality results linked to sample Reel external IDs\nwith sample_data as (\n    select 1 as test_num, 'reel:2023:EM0010126020' as reel_external_id, 'EM0010126020' as reel_number, 'Caliper' as test_name, 'Lab' as test_method, 'Dimensional' as test_type\n    union all select 2, 'reel:2023:EM0010126020', 'EM0010126020', 'Moisture', 'Scanner', 'Physical'\n    union all select 3, 'reel:2023:EM0010126020', 'EM0010126020', 'Basis Weight', 'Inspection', 'Physical'\n    union all select 4, 'reel:2023:EM0010126020', 'EM0010126020', 'Brightness', 'Lab', 'Physical'\n    union all select 5, 'reel:2022:EM0011230018', 'EM0011230018', 'Caliper', 'Scanner', 'Dimensional'\n    union all select 6, 'reel:2022:EM0011230018', 'EM0011230018', 'Moisture', 'Inspection', 'Physical'\n    union all select 7, 'reel:2023:EM0010312012', 'EM0010312012', 'Basis Weight', 'Lab', 'Physical'\n    union all select 8, 'reel:2023:EM0010312012', 'EM0010312012', 'Brightness', 'Scanner', 'Physical'\n    union all select 9, 'reel:2023:EM0010109032', 'EM0010109032', 'Caliper', 'Inspection', 'Dimensional'\n    union all select 10, 'reel:2023:EM0010109032', 'EM0010109032', 'Moisture', 'Lab', 'Physical'\n    union all select 11, 'reel:2023:EM0010305020', 'EM0010305020', 'Basis Weight', 'Scanner', 'Physical'\n    union all select 12, 'reel:2023:EM0010305020', 'EM0010305020', 'Brightness', 'Inspection', 'Physical'\n    union all select 13, 'reel:2023:EM0010126020', 'EM0010126020', 'Caliper', 'Lab', 'Dimensional'\n    union all select 14, 'reel:2022:EM0011230018', 'EM0011230018', 'Moisture', 'Scanner', 'Physical'\n    union all select 15, 'reel:2023:EM0010312012', 'EM0010312012', 'Basis Weight', 'Inspection', 'Physical'\n    union all select 16, 'reel:2023:EM0010109032', 'EM0010109032', 'Brightness', 'Lab', 'Physical'\n    union all select 17, 'reel:2023:EM0010305020', 'EM0010305020', 'Caliper', 'Scanner', 'Dimensional'\n    union all select 18, 'reel:2023:EM0010126020', 'EM0010126020', 'Moisture', 'Inspection', 'Physical'\n    union all select 19, 'reel:2022:EM0011230018', 'EM0011230018', 'Basis Weight', 'Lab', 'Physical'\n    union all select 20, 'reel:2023:EM0010312012', 'EM0010312012', 'Brightness', 'Scanner', 'Physical'\n)\n\nselect\n    concat('qualitytestresult:', sd.reel_number, '-', sd.test_name, '-', cast(sd.test_num as string)) as externalId,\n    'sylvamo_isa' as space,\n    concat(sd.reel_number, '-', sd.test_name, '-', cast(sd.test_num as string)) as resultId,\n    \n    -- ============================================================\n    -- CogniteDescribable (required by view)\n    -- ============================================================\n    concat(sd.test_name, ' Test Result for Reel ', sd.reel_number) as name,\n    concat('Quality test result: ', sd.test_name, ' (', sd.test_method, ') for reel ', sd.reel_number, '. Test type: ', sd.test_type) as description,\n    \n    -- ============================================================\n    -- Test Information\n    -- ============================================================\n    sd.test_name as testName,\n    sd.test_method as testMethod,\n    sd.test_type as testType,\n    \n    -- ============================================================\n    -- Result Values (sample data)\n    -- ============================================================\n    case sd.test_name\n        when 'Caliper' then 4.5 + (random() * 1.0)  -- 4.5-5.5 MILS\n        when 'Moisture' then 5.0 + (random() * 2.0)  -- 5.0-7.0%\n        when 'Basis Weight' then 60.0 + (random() * 10.0)  -- 60-70 lbs\n        else 85.0 + (random() * 5.0)  -- Brightness: 85-90\n    end as resultValue,\n    \n    null as resultText,  -- For numeric results\n    \n    -- Test date: current date (changed from timestamp)\n    current_date() as resultDate,\n    \n    case sd.test_name\n        when 'Caliper' then 'MILS'\n        when 'Moisture' then '%'\n        when 'Basis Weight' then 'lbs'\n        else 'ISO'\n    end as unitOfMeasure,\n    \n    -- ============================================================\n    -- Specification Comparison\n    -- ============================================================\n    case sd.test_name\n        when 'Caliper' then 4.0\n        when 'Moisture' then 4.0\n        when 'Basis Weight' then 55.0\n        else 80.0\n    end as specMin,\n    \n    case sd.test_name\n        when 'Caliper' then 6.0\n        when 'Moisture' then 8.0\n        when 'Basis Weight' then 75.0\n        else 95.0\n    end as specMax,\n    \n    case sd.test_name\n        when 'Caliper' then 5.0\n        when 'Moisture' then 6.0\n        when 'Basis Weight' then 65.0\n        else 87.5\n    end as specTarget,\n    \n    -- isInSpec: Check if resultValue is within specMin-specMax\n    case sd.test_name\n        when 'Caliper' then \n            (4.5 + (random() * 1.0)) between 4.0 and 6.0\n        when 'Moisture' then \n            (5.0 + (random() * 2.0)) between 4.0 and 8.0\n        when 'Basis Weight' then \n            (60.0 + (random() * 10.0)) between 55.0 and 75.0\n        else \n            (85.0 + (random() * 5.0)) between 80.0 and 95.0\n    end as isInSpec,\n    \n    -- deviation: resultValue - specTarget (calculated in transformation)\n    case sd.test_name\n        when 'Caliper' then (4.5 + (random() * 1.0)) - 5.0\n        when 'Moisture' then (5.0 + (random() * 2.0)) - 6.0\n        when 'Basis Weight' then (60.0 + (random() * 10.0)) - 65.0\n        else (85.0 + (random() * 5.0)) - 87.5\n    end as deviation,\n    \n    -- ============================================================\n    -- Source Tracking\n    -- ============================================================\n    'Sample' as sourceSystem,\n    concat('sample-', cast(sd.test_num as string)) as sourceId,\n    \n    -- ============================================================\n    -- Metadata\n    -- ============================================================\n    'Complete' as status,\n    concat('Sample quality test for reel ', sd.reel_number) as notes,\n    current_date() as createdDate\n    \nfrom sample_data sd\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_Site",
    "name": "[ISA] Populate Site Reference Data",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate Site Reference Data\n   \n   Purpose:\n   - Creates Site nodes for ISA-95 equipment hierarchy\n   - Static reference data (not extracted from source systems)\n   \n   Sites:\n   - Eastover Mill: Primary paper production\n   - Sumpter: Finishing and packaging facility\n*/\n\n-- Eastover Mill\nselect\n    'site:eastover' as externalId,\n    'sylvamo_isa' as space,\n    'EASTOVER' as siteId,\n    'Eastover Mill' as name,\n    'Eastover, South Carolina' as location,\n    'USA' as country,\n    'Site' as isaLevel,\n    'Mill' as siteType,\n    'Primary paper production facility with two paper machines (PM1, PM2)' as description\n\nunion all\n\n-- Sumpter Facility\nselect\n    'site:sumpter' as externalId,\n    'sylvamo_isa' as space,\n    'SUMPTER' as siteId,\n    'Sumpter Facility' as name,\n    'Sumpter, South Carolina' as location,\n    'USA' as country,\n    'Site' as isaLevel,\n    'FinishingFacility' as siteType,\n    'Finishing, quality inspection, and packaging facility' as description\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_Unit",
    "name": "[ISA] Populate Unit Reference Data",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate Unit Reference Data\n   \n   Purpose:\n   - Creates Unit nodes for ISA-95 equipment hierarchy\n   - Static reference data (not extracted from source systems)\n   \n   Units at Eastover:\n   - PM1: Paper Machine 1 (PU_Id = 4 in Proficy)\n   - PM2: Paper Machine 2 (PU_Id = 5 in Proficy)\n   - Winder1: Cuts reels into rolls\n   \n   Units at Sumpter:\n   - Rewinder1: Reprocesses rolls\n   - Packager1: Creates shipping packages\n*/\n\n-- Paper Machine 1\nselect\n    'unit:pm1' as externalId,\n    'sylvamo_isa' as space,\n    'PM1' as unitId,\n    'Paper Machine 1' as name,\n    'PaperMachine' as unitClass,\n    'Fourdrinier' as unitType,\n    500.0 as capacity,\n    'tons/day' as capacityUnit,\n    'Unit' as isaLevel,\n    'Paper Machine 1 at Eastover Mill - produces reels from pulp' as description,\n    'Active' as status,\n    node_reference('sylvamo_isa', 'site:eastover') as site\n\nunion all\n\n-- Paper Machine 2\nselect\n    'unit:pm2' as externalId,\n    'sylvamo_isa' as space,\n    'PM2' as unitId,\n    'Paper Machine 2' as name,\n    'PaperMachine' as unitClass,\n    'Fourdrinier' as unitType,\n    600.0 as capacity,\n    'tons/day' as capacityUnit,\n    'Unit' as isaLevel,\n    'Paper Machine 2 at Eastover Mill - produces reels from pulp' as description,\n    'Active' as status,\n    node_reference('sylvamo_isa', 'site:eastover') as site\n\nunion all\n\n-- Winder 1\nselect\n    'unit:winder1' as externalId,\n    'sylvamo_isa' as space,\n    'WINDER1' as unitId,\n    'Winder 1' as name,\n    'Winder' as unitClass,\n    'Slitter-Rewinder' as unitType,\n    200.0 as capacity,\n    'rolls/day' as capacityUnit,\n    'Unit' as isaLevel,\n    'Winder at Eastover Mill - cuts reels into individual rolls' as description,\n    'Active' as status,\n    node_reference('sylvamo_isa', 'site:eastover') as site\n\nunion all\n\n-- Rewinder 1 (Sumpter)\nselect\n    'unit:rewinder1' as externalId,\n    'sylvamo_isa' as space,\n    'REWINDER1' as unitId,\n    'Rewinder 1' as name,\n    'Rewinder' as unitClass,\n    'Slitter-Rewinder' as unitType,\n    150.0 as capacity,\n    'rolls/day' as capacityUnit,\n    'Unit' as isaLevel,\n    'Rewinder at Sumpter - reprocesses rolls if needed' as description,\n    'Active' as status,\n    node_reference('sylvamo_isa', 'site:sumpter') as site\n\nunion all\n\n-- Packager 1 (Sumpter)\nselect\n    'unit:packager1' as externalId,\n    'sylvamo_isa' as space,\n    'PACKAGER1' as unitId,\n    'Packager 1' as name,\n    'Packager' as unitClass,\n    'Automated' as unitType,\n    300.0 as capacity,\n    'packages/day' as capacityUnit,\n    'Unit' as isaLevel,\n    'Packaging line at Sumpter - creates shipping packages' as description,\n    'Active' as status,\n    node_reference('sylvamo_isa', 'site:sumpter') as site\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr-proficy-readings-datapoints",
    "name": "proficy-readings-datapoints",
    "query": "/* Populate Proficy readings centric timeseries with datapoints\n\there each datapoint is a reading from a tag/sensor */\n\n-- previous query to go to Cognite Core Timeseries\nselect\n\tconcat(\"proficy_readings_timeseries_\", `Var_Id`) as externalId,\n  \tto_utc_timestamp(`Productive_Start_Time`, 'US/Eastern') as timestamp,\n  \tcast(`Result` as double) as value\nfrom `raw_ext_sql_proficy`.`events_tests`\nwhere `Result` is not NULL  -- not all reels recieve tests from every tag/sensor\n\tand is_new('version_tracker', `lastUpdatedTime`)",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "TransformationDestination"
  },
  {
    "external_id": "tr-proficy-reels-timeseries",
    "name": "proficy-reels-timeseries",
    "query": "-- /* Create timeseries, one for each paper machine from the Proficy data\n-- \twhere each datapoint will be the reel number the machine had at that timestamp */\n\n-- with GROUP_BY_PU_ID as (\n--   select\n--   \tconcat(case `PU_Id` \n--               when 4 then \"Paper Machine 1 - Reels\" \n--               when 5 then \"Paper Machine 2 - Reels\" end) as name,\n--   \t-- concat(\"proficy_reels_timeseries_\", `PU_Id`) as externalId,\n--   \t`PU_Id`\n--   from `raw_ext_sql_proficy`.`events_tests`\n--   where `PU_Id` is not NULL\n--   group by `PU_Id`\n-- )\n\n-- -- final select statement\n-- select\n--   \"sylvamo_mfg_core_instances\" as space,\n--   name,\n--   concat(\"proficy:reels_timeseries_\", `PU_Id`) as externalId,\n--   int(`PU_Id`) as productionUnitId,\n--   \"string\" as type,  -- we're storing Event_Num as the datapoints which take the form: \"24-010102028\"\n--   false as isStep,\n--   case `PU_Id`\n--   \twhen 4 then array( node_reference(\"sylvamo_mfg_core_instances\", \"floc:0769-06-01-010\") )  -- #1 Paper Machine\n--   \twhen 5 then array( node_reference(\"sylvamo_mfg_core_instances\", \"floc:0769-06-01-020\") )  -- #2 Paper Machine\n--   end as assets,\n--   dataset_id(\"ds_timeseries_Eastover\") as dataSetId\n-- from GROUP_BY_PU_ID\n\nselect \n  * except (externalId)\n  -- 'proficy:reels_timeseries_4' as externalId\nfrom cdf_nodes(\n  'sylvamo_mfg_core_schema',        -- space of your data model\n  'MfgTimeSeries',   -- externalId of your data model\n  'v1'      -- version of your data model\n)\nwhere externalId == \"proficy_reels_timeseries_4\"",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Instances"
  },
  {
    "external_id": "tr_link_Reel_TimeSeries",
    "name": "[Products] Link Reels to Paper Machine Time Series",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Link Reels to Paper Machine Time Series\n   \n   Purpose:\n   - Links each Reel to the time series from its paper machine\n   - Enables graph traversal: Reel -> timeSeries -> (PI data)\n   \n   Linking Logic:\n   - PM1 reels (EM001xxx) -> Time Series for floc:0769-06-01-010\n   - PM2 reels (EM002xxx) -> Time Series for floc:0769-06-01-020\n   \n   Note: Time series are shared across all reels from the same machine.\n   For time-window specific data, query the time series datapoints using\n   the reel's startTime and endTime.\n*/\n\n-- Get reels with their paper machine info\nwith reel_pm_mapping as (\n    select\n        r.externalId as reel_external_id,\n        r.space as reel_space,\n        r.reelNumber,\n        r.startTime,\n        r.endTime,\n        -- Map reel to FunctionalLocation based on paper machine\n        case\n            when r.paperMachine = 'PM1' or substring(r.reelNumber, 3, 3) = '001' \n                then 'floc:0769-06-01-010'\n            when r.paperMachine = 'PM2' or substring(r.reelNumber, 3, 3) = '002' \n                then 'floc:0769-06-01-020'\n            else null\n        end as floc_external_id\n    from cdf_data_models(\n        space => 'sylvamo_products',\n        dataModel => 'SylvamoProducts',\n        version => 'v3',\n        view => 'Reel'\n    ) r\n    where r.reelNumber is not null\n),\n\n-- Get time series linked to each paper machine\nts_pm_mapping as (\n    select\n        ts.externalId as ts_external_id,\n        ts.space as ts_space,\n        ts.name as ts_name,\n        asset.externalId as asset_external_id\n    from cdf_data_models(\n        space => 'enterprise_model',\n        dataModel => 'SylvamoEnterprise',\n        version => 'v5',\n        view => 'SylvamoTimeSeries'\n    ) ts\n    lateral view explode(ts.assets) exploded as asset\n    where asset.externalId in ('floc:0769-06-01-010', 'floc:0769-06-01-020')\n)\n\n-- Link reels to their paper machine's time series\nselect\n    rpm.reel_external_id as externalId,\n    rpm.reel_space as space,\n    \n    -- Collect all time series for this reel's paper machine\n    collect_list(\n        node_reference('enterprise_model', tspm.ts_external_id)\n    ) as timeSeries\n    \nfrom reel_pm_mapping rpm\ninner join ts_pm_mapping tspm on rpm.floc_external_id = tspm.asset_external_id\nwhere rpm.floc_external_id is not null\ngroup by rpm.reel_external_id, rpm.reel_space\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_FunctionalLocation_from_SAP",
    "name": "[Raw Ext Analysis] Populate FunctionalLocation from SAP",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate FunctionalLocation from SAP Asset Hierarchy\n   \n   Source RAW Table: raw_ext_sap.asset_hierarchy\n*/\n\nselect\n    -- Instance identification\n    concat('floc:', functional_location) as externalId,\n    'sylvamo_raw_ext_analysis' as space,\n    \n    -- Functional Location Identification\n    functional_location as functionalLocation,\n    functional_location_description as functionalLocationDescription,\n    \n    -- Hierarchy Information\n    cast(hierarchy_level as int) as hierarchyLevel,\n    \n    -- Work Center Information\n    work_center_code as workCenterCode,\n    work_center_description as workCenterDescription,\n    \n    -- Equipment Reference (as array if multiple)\n    -- Note: equipment field is often null, handle gracefully\n    cast(null as array<string>) as equipment,  -- Equipment not populated from this source\n    \n    -- Metadata\n    cast(total_rows as int) as totalRows\n    \nfrom `raw_ext_sap`.`asset_hierarchy`\nwhere functional_location is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_Material_from_SAP",
    "name": "[Raw Ext Analysis] Populate Material from SAP",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate Material from SAP Materials\n   \n   Source RAW Table: raw_ext_sap.materials\n*/\n\nselect\n    -- Instance identification\n    concat('mat:', material_number) as externalId,\n    'sylvamo_raw_ext_analysis' as space,\n    \n    -- Material Identification\n    material_number as materialNumber,\n    material_description as materialDescription,\n    material_type as materialType,\n    material_group as materialGroup,\n    \n    -- Stock Information\n    cast(total_stock as double) as totalStock,\n    cast(unrestricted_stock as double) as unrestrictedStock,\n    cast(blocked_stock as double) as blockedStock,\n    cast(quality_inspection_stock as double) as qualityInspectionStock,\n    cast(safety_stock as double) as safetyStock,\n    cast(reorder_point as double) as reorderPoint,\n    \n    -- Unit of Measure\n    base_unit_of_measure as baseUnitOfMeasure,\n    \n    -- MRP Information\n    mrp_type as mrpType,\n    mrp_controller as mrpController,\n    \n    -- Status\n    cast(deletion_flag as boolean) as deletionFlag,\n    to_timestamp(created_on) as createdOn\n    \nfrom `raw_ext_sap`.`materials`\nwhere material_number is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_ProductionOrder_from_SAP",
    "name": "[Raw Ext Analysis] Populate ProductionOrder from SAP",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate ProductionOrder from SAP Production Orders\n   \n   Source RAW Table: raw_ext_sap.production_orders\n*/\n\nselect\n    -- Instance identification\n    concat('po:', cast(production_order_number as string)) as externalId,\n    'sylvamo_raw_ext_analysis' as space,\n    \n    -- Production Order Identification\n    cast(production_order_number as bigint) as productionOrderNumber,\n    order_type as orderType,\n    approximate_order_status as approximateOrderStatus,\n    cast(production_progress_percentage as double) as productionProgressPercentage,\n    \n    -- Produced Material\n    produced_material_number as producedMaterialNumber,\n    produced_material_description as producedMaterialDescription,\n    cast(planned_total_quantity as double) as plannedTotalQuantity,\n    base_unit_of_measure as baseUnitOfMeasure,\n    \n    -- Dates\n    to_timestamp(basic_start_date) as basicStartDate,\n    to_timestamp(basic_finish_date) as basicFinishDate,\n    \n    -- Component Information\n    component_item_number as componentItemNumber,\n    component_material_number as componentMaterialNumber,\n    component_material_description as componentMaterialDescription,\n    cast(component_required_quantity as double) as componentRequiredQuantity,\n    cast(component_withdrawn_quantity as double) as componentWithdrawnQuantity,\n    cast(component_withdrawal_percentage as double) as componentWithdrawalPercentage\n    \nfrom `raw_ext_sap`.`production_orders`\nwhere production_order_number is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_RollQuality_from_SharePoint",
    "name": "[Raw Ext Analysis] Populate RollQuality from SharePoint",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate RollQuality from SharePoint Roll Quality\n   \n   Source RAW Table: raw_ext_sharepoint.roll_quality\n*/\n\nselect\n    -- Instance identification (use first available roll_id)\n    concat('rq:', coalesce(\n        roll_id_3,\n        roll_id_no_2,\n        roll_id_no_4,\n        roll_id_no_5,\n        roll_id_no_6,\n        cast(row_number() over (order by date) as string)\n    )) as externalId,\n    'sylvamo_raw_ext_analysis' as space,\n    \n    -- Roll Identification\n    roll_id_3 as rollId,\n    roll_id_no_2 as rollId2,\n    roll_id_no_4 as rollId4,\n    roll_id_no_5 as rollId5,\n    roll_id_no_6 as rollId6,\n    \n    -- Quality Information\n    was_the_roll_rejected as wasTheRollRejected,\n    defect,\n    defect_non_damage as defectNonDamage,\n    was_the_defect_damage as wasTheDefectDamage,\n    is_there_more_than_one as isThereMoreThanOne,\n    \n    -- Location and Equipment\n    location,\n    equipment,\n    \n    -- Time and Impact\n    to_timestamp(date) as date,\n    cast(minutes_lost as double) as minutesLost,\n    \n    -- Feedback\n    feedback_from_the_paper_machines as feedbackFromThePaperMachines,\n    do_you_have_any_feedback_about_this_roll_quality_reporting_process as doYouHaveAnyFeedbackAboutThisRollQualityReportingProcess,\n    \n    -- Metadata\n    created_by as createdBy,\n    who_is_entering as whoIsEntering,\n    title,\n    item_type as itemType,\n    path\n    \nfrom `raw_ext_sharepoint`.`roll_quality`\nwhere roll_id_3 is not null \n   or roll_id_no_2 is not null \n   or roll_id_no_4 is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_WorkOrder_from_SAP",
    "name": "[Raw Ext Analysis] Populate WorkOrder from SAP",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate WorkOrder from SAP Work Orders\n   \n   Source RAW Table: raw_ext_sap.work_orders\n*/\n\nselect\n    -- Instance identification\n    concat('wo:', cast(cast(work_order_number as bigint) as string)) as externalId,\n    'sylvamo_raw_ext_analysis' as space,\n    \n    -- Work Order Identification\n    cast(cast(work_order_number as bigint) as string) as workOrderNumber,\n    work_order_description as workOrderDescription,\n    \n    -- Order Details\n    order_status as orderStatus,\n    cast(order_phase_code as int) as orderPhaseCode,\n    to_timestamp(order_created_date) as orderCreatedDate,\n    created_by_user as createdByUser,\n    \n    -- Equipment Information\n    cast(equipment_number as bigint) as equipmentNumber,\n    equipment_description as equipmentDescription,\n    \n    -- Functional Location\n    functional_location as functionalLocation,\n    functional_location_description as functionalLocationDescription,\n    \n    -- Maintenance Activity\n    cast(maintenance_activity_type as int) as maintenanceActivityType\n    \nfrom `raw_ext_sap`.`work_orders`\nwhere work_order_number is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_MaterialCostVariance_from_Pilot",
    "name": "[Products] Populate MaterialCostVariance from Pilot PPV",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate MaterialCostVariance from Pilot PPV Snapshot\n   \n   Purpose:\n   - Reads PPV financial data from RAW pilot database\n   - Creates MaterialCostVariance nodes linking to FunctionalLocation (Plant)\n   - Supports UC1: Material Cost Analysis\n   \n   Source RAW Table: raw_sylvamo_pilot_OLD_TO_DELETE.fabric_ppv_snapshot\n   Destination: sylvamo_products.MaterialCostVariance view (v1)\n   \n   Column names are lowercase in pilot database.\n   Plant is int (e.g., 769), not string.\n*/\n\nselect\n    -- Instance identification\n    concat('ppv:', cast(plant as string), ':', cast(material as string), ':', cast(current_fiscper_from as string)) as externalId,\n    'sylvamo_products' as space,\n    \n    -- MaterialCostVariance properties\n    cast(material as string) as material,\n    cast(material_type as string) as materialType,\n    cast(material_description as string) as materialDescription,\n    cast(plant as int) as plant,\n    \n    -- Link to FunctionalLocation (Plant) - use enterprise_model space, plant is int (e.g., 769)\n    -- Note: FunctionalLocation nodes must exist before referencing them\n    -- For now, set to null - will be populated after FunctionalLocation hierarchy is created\n    null as functionalLocation,\n    \n    -- Fiscal period (parse from string format)\n    to_timestamp(concat(cast(current_fiscper_from as string), '01'), 'yyyyMMdd') as fiscalPeriod,\n    to_timestamp(concat(cast(current_fiscper_from as string), '01'), 'yyyyMMdd') as currentFiscalPeriodFrom,\n    to_timestamp(concat(cast(current_fiscper_to as string), '01'), 'yyyyMMdd') as currentFiscalPeriodTo,\n    to_timestamp(concat(cast(prior_fiscper_from as string), '01'), 'yyyyMMdd') as priorFiscalPeriodFrom,\n    to_timestamp(concat(cast(prior_fiscper_to as string), '01'), 'yyyyMMdd') as priorFiscalPeriodTo,\n    \n    -- Financial metrics - Current period\n    cast(current_quantity as double) as currentQuantity,\n    cast(current_standard_cost as double) as currentStandardCost,\n    cast(current_unit_cost as double) as currentUnitCost,\n    cast(current_ppv as double) as currentPPV,\n    \n    -- Financial metrics - Prior period\n    cast(prior_quantity as double) as priorQuantity,\n    cast(prior_standard_cost as double) as priorStandardCost,\n    cast(prior_unit_cost as double) as priorUnitCost,\n    cast(prior_ppv as double) as priorPPV,\n    \n    -- Accounting\n    cast(gl_account as string) as glAccount,\n    cast(units as string) as units,\n    cast(record_type as string) as recordType,\n    \n    -- Source system tracking\n    'Pilot' as sourceSystem\n    \nfrom `raw_sylvamo_pilot_OLD_TO_DELETE`.`fabric_ppv_snapshot`\nwhere material is not null \n  and plant is not null\n  and current_fiscper_from is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_Package_from_Pilot",
    "name": "[Products] Populate Package from Pilot Data (CDM)",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate Package from Pilot PPR History (CDM-based)\n   \n   Purpose:\n   - Reads package production data from RAW pilot database\n   - Creates Package nodes extending CogniteAsset with parent Roll relationship\n   - Sets parent=Roll via reverse lookup (Rolls reference Packages)\n   \n   Source RAW Table: raw_sylvamo_pilot_OLD_TO_DELETE.fabric_ppr_hist_package\n   Destination: sylvamo_products.Package view (implements CogniteAsset v1)\n   \n   Column names are lowercase in pilot database.\n   Date format: int32 YYYYMMDD (e.g., 20220704)\n   \n   Note: Package parent relationship is REVERSE - Rolls reference Packages via\n   roll_pack_package_number. We join with Roll table to find the parent Roll.\n*/\n\nselect\n    -- Instance identification\n    concat('package:', cast(pack_package_number as string)) as externalId,\n    'sylvamo_products' as space,\n    \n    -- Core CogniteAsset properties (inherited from CDM)\n    cast(pack_package_number as string) as name,\n    concat('Package: ', cast(pack_package_number as string)) as description,\n    cast(pack_package_number as string) as sourceId,\n    \n    -- CDM Hierarchy: parent=Roll (via reverse lookup from Roll table)\n    -- Join with Roll table to find which Roll references this Package\n    case\n        when roll.roll_number is not null \n             and trim(cast(roll.roll_number as string)) != ''\n        then\n            node_reference('sylvamo_products', concat('roll:', cast(roll.roll_number as string)))\n        else null\n    end as parent,\n    \n    -- Source system reference (remove - Fabric source node doesn't exist)\n    null as source,\n    \n    -- Package-specific properties (from Package container)\n    cast(pack.pack_package_number as string) as packageNumber,\n    \n    -- Package metadata (convert int32 YYYYMMDD to timestamp)\n    case\n        when pack.pack_assembled_date is not null then\n            to_timestamp(\n                concat(\n                    substring(cast(pack.pack_assembled_date as string), 1, 4), '-',\n                    substring(cast(pack.pack_assembled_date as string), 5, 2), '-',\n                    substring(cast(pack.pack_assembled_date as string), 7, 2)\n                ),\n                'yyyy-MM-dd'\n            )\n        else null\n    end as assembledDate,\n    -- Shipped date: pack_ship_date is string, may be empty\n    case\n        when pack.pack_ship_date is not null \n             and trim(cast(pack.pack_ship_date as string)) != ''\n             and length(trim(cast(pack.pack_ship_date as string))) = 8 then\n            to_timestamp(\n                concat(\n                    substring(trim(cast(pack.pack_ship_date as string)), 1, 4), '-',\n                    substring(trim(cast(pack.pack_ship_date as string)), 5, 2), '-',\n                    substring(trim(cast(pack.pack_ship_date as string)), 7, 2)\n                ),\n                'yyyy-MM-dd'\n            )\n        else null\n    end as shippedDate,\n    -- Destination not directly available\n    null as destination,\n    \n    -- Package contents\n    cast(pack.pack_number_rolls_in_package as int) as numberOfRolls,\n    cast(pack.pack_package_gross_wt as double) as totalWeight,\n    \n    -- Link to FunctionalLocation (Finishing/Shipping area)\n    -- Not directly available in pilot data\n    null as functionalLocation,\n    \n    -- Source system tracking\n    'Pilot' as sourceSystem\n    \nfrom `raw_sylvamo_pilot_OLD_TO_DELETE`.`fabric_ppr_hist_package` as pack\n-- Left join with Roll table to find parent Roll (reverse relationship)\nleft join `raw_sylvamo_pilot_OLD_TO_DELETE`.`fabric_ppr_hist_roll` as roll\n    on trim(cast(pack.pack_package_number as string)) = trim(cast(roll.roll_pack_package_number as string))\nwhere pack.pack_package_number is not null\n    and trim(cast(pack.pack_package_number as string)) != ''\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_Reel_from_Pilot",
    "name": "[Products] Populate Reel from Pilot Data (CDM)",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate Reel from Pilot PPR History (CDM-based)\n   \n   Purpose:\n   - Reads reel production data from RAW pilot database\n   - Creates Reel nodes extending CogniteAsset for hierarchical navigation\n   - Sets parent=null (root of production hierarchy)\n   \n   Source RAW Table: raw_sylvamo_pilot_OLD_TO_DELETE.fabric_ppr_hist_reel\n   Destination: sylvamo_products.Reel view (implements CogniteAsset v1)\n   \n   Column names are lowercase in pilot database.\n   Date format: int32 YYYYMMDD (e.g., 20230110)\n*/\n\nselect\n    -- Instance identification\n    concat('reel:', cast(reel_number as string)) as externalId,\n    'sylvamo_products' as space,\n    \n    -- Core CogniteAsset properties (inherited from CDM)\n    cast(reel_number as string) as name,\n    concat('Paper Reel: ', cast(reel_number as string)) as description,\n    cast(reel_number as string) as sourceId,\n    \n    -- CDM Hierarchy: parent=null for root nodes\n    null as parent,\n    \n    -- Source system reference (remove - Fabric source node doesn't exist)\n    -- node_reference('enterprise_model', 'Fabric') as source,\n    null as source,\n    \n    -- Reel-specific properties (from Reel container)\n    cast(reel_number as string) as reelNumber,\n    \n    -- Production metadata (convert int32 YYYYMMDD to timestamp)\n    -- Use to_timestamp with proper format - Spark SQL uses 'yyyy-MM-dd' or 'yyyyMMdd'\n    case\n        when reel_manufactured_date is not null and cast(reel_manufactured_date as string) != '' then\n            to_timestamp(\n                concat(\n                    substring(cast(reel_manufactured_date as string), 1, 4), '-',\n                    substring(cast(reel_manufactured_date as string), 5, 2), '-',\n                    substring(cast(reel_manufactured_date as string), 7, 2)\n                ),\n                'yyyy-MM-dd'\n            )\n        else null\n    end as manufacturedDate,\n    -- Extract paper machine from reel_number prefix (EM001 = PM1, EM002 = PM2)\n    case\n        when substring(cast(reel_number as string), 1, 5) = 'EM001' then 'PM1'\n        when substring(cast(reel_number as string), 1, 5) = 'EM002' then 'PM2'\n        else null\n    end as paperMachine,\n    cast(reel_product_code as string) as grade,\n    \n    -- Physical properties\n    cast(reel_calc_weight as double) as weight,\n    cast(reel_reel_width_wh as int) as width,\n    \n    -- Link to FunctionalLocation (Paper Machine equipment)\n    -- Map reel_number prefix to Paper Machine FLOC\n    -- Note: FunctionalLocation nodes must exist before referencing them\n    -- For now, set to null - will be populated after FunctionalLocation hierarchy is created\n    null as functionalLocation,\n    \n    -- Source system tracking\n    'Pilot' as sourceSystem\n    \nfrom `raw_sylvamo_pilot_OLD_TO_DELETE`.`fabric_ppr_hist_reel`\nwhere reel_number is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_Roll_from_Pilot",
    "name": "[Products] Populate Roll from Pilot Data (CDM)",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate Roll from Pilot PPR History (CDM-based)\n   \n   Purpose:\n   - Reads roll production data from RAW pilot database\n   - Creates Roll nodes extending CogniteAsset with parent Reel relationship\n   - Sets parent=roll_reel_number for hierarchical navigation\n   \n   Source RAW Table: raw_sylvamo_pilot_OLD_TO_DELETE.fabric_ppr_hist_roll\n   Destination: sylvamo_products.Roll view (implements CogniteAsset v1)\n   \n   Column names are lowercase in pilot database.\n   Date format: int32 YYYYMMDD (e.g., 20230208)\n*/\n\nselect\n    -- Instance identification\n    concat('roll:', cast(roll_number as string)) as externalId,\n    'sylvamo_products' as space,\n    \n    -- Core CogniteAsset properties (inherited from CDM)\n    cast(roll_number as string) as name,\n    concat('Paper Roll: ', cast(roll_number as string)) as description,\n    cast(roll_number as string) as sourceId,\n    \n    -- CDM Hierarchy: parent=roll_reel_number (for production hierarchy)\n    case\n        when roll_reel_number is not null \n             and roll_reel_number not like '%DUMMY%' \n             and trim(cast(roll_reel_number as string)) != ''\n        then\n            node_reference('sylvamo_products', concat('reel:', cast(roll_reel_number as string)))\n        else null\n    end as parent,\n    \n    -- Source system reference (remove - Fabric source node doesn't exist)\n    null as source,\n    \n    -- Roll-specific properties (from Roll container)\n    cast(roll_number as string) as rollNumber,\n    cast(roll_reel_number as string) as reelNumber,  -- Text reference for lookup\n    \n    -- Production metadata (date is int32 YYYYMMDD format)\n    cast(roll_manufactured_date as int) as manufacturedDate,\n    -- Winder not directly available, derive from reel relationship\n    null as winder,\n    -- Use roll_current_mpmp or roll_grade_desc_subs_code for grade\n    coalesce(\n        cast(roll_grade_desc_subs_code as string),\n        substring(cast(roll_current_mpmp as string), 1, 10)\n    ) as grade,\n    \n    -- Package relationship (text reference)\n    cast(roll_pack_package_number as string) as packageNumber,\n    \n    -- Physical properties (use roll_calculated_weight - correct column name)\n    coalesce(\n        cast(roll_calculated_weight as double),\n        cast(roll_metric_net_wt as double)\n    ) as weight,\n    -- Width not directly available in pilot data\n    null as width,\n    cast(roll_caliper as double) as caliper,\n    \n    -- Set information (required property)\n    coalesce(\n        cast(roll_set_number as string),\n        cast(roll_reel_set_number as string),\n        'UNKNOWN'\n    ) as rollSetNumber,\n    \n    -- Link to FunctionalLocation (Paper Machine via roll_paper_machine)\n    -- Note: FunctionalLocation nodes must exist before referencing them\n    -- For now, set to null - will be populated after FunctionalLocation hierarchy is created\n    null as functionalLocation,\n    \n    -- Source system tracking\n    'Pilot' as sourceSystem\n    \nfrom `raw_sylvamo_pilot_OLD_TO_DELETE`.`fabric_ppr_hist_roll`\nwhere roll_number is not null\n    and trim(cast(roll_number as string)) != ''\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_QualityResult_from_Pilot",
    "name": "[Products] Populate QualityResult from Pilot SharePoint Data",
    "query": "-- cdf-auth: f9b1f784\n/*\n   Transformation: Populate QualityResult from SharePoint Roll Quality\n   \n   Purpose:\n   - Reads quality inspection data from SharePoint (pilot database)\n   - Creates QualityResult nodes linking to Roll entities\n   - Links to FunctionalLocation via Roll \u2192 Reel \u2192 FunctionalLocation chain\n   \n   Source RAW Table: raw_sylvamo_pilot_OLD_TO_DELETE.sharepoint_roll_quality\n   Destination: sylvamo_products.QualityResult view (v1)\n   \n   Roll ID Format Challenge:\n   - SharePoint uses: E15M06043C (format: E + digits + letter)\n   - Roll table uses: EME13B08061N (format: EM + digits + letter)\n   - Solution: Try multiple roll_id fields and normalize matching\n*/\n\nwith quality_data as (\n    select\n        *,\n        -- Try to match roll IDs - check multiple roll_id fields\n        coalesce(\n            roll_id_no_2,\n            roll_id_3,\n            roll_id_no_4,\n            roll_id_no_5,\n            roll_id_no_6\n        ) as primary_roll_id,\n        -- Generate unique externalId\n        concat(\n            'quality:',\n            coalesce(cast(date as string), 'unknown'),\n            ':',\n            coalesce(roll_id_no_2, roll_id_3, 'unknown')\n        ) as quality_external_id\n    from `raw_sylvamo_pilot_OLD_TO_DELETE`.`sharepoint_roll_quality`\n    where (roll_id_no_2 is not null or roll_id_3 is not null)\n),\n\nroll_matching as (\n    -- Try to find matching rolls with different ID formats\n    select\n        q.*,\n        r.roll_number as matched_roll_number,\n        -- Try direct match first\n        case\n            when q.primary_roll_id = r.roll_number then r.roll_number\n            -- Try normalized match (remove EM prefix)\n            when q.primary_roll_id = substring(r.roll_number, 3) then r.roll_number\n            -- Try adding EM prefix to quality roll ID\n            when concat('EM', q.primary_roll_id) = r.roll_number then r.roll_number\n            else null\n        end as roll_match\n    from quality_data q\n    left join `raw_sylvamo_pilot_OLD_TO_DELETE`.`fabric_ppr_hist_roll` r\n        on q.primary_roll_id = r.roll_number\n        or q.primary_roll_id = substring(r.roll_number, 3)\n        or concat('EM', q.primary_roll_id) = r.roll_number\n)\n\nselect\n    -- Instance identification\n    quality_external_id as externalId,\n    'sylvamo_products' as space,\n    \n    -- Quality identifiers\n    quality_external_id as qualityResultId,\n    \n    -- Production entity references (text for lookup)\n    primary_roll_id as rollNumber,\n    \n    -- Direct relation to Roll (if matched)\n    case\n        when matched_roll_number is not null then\n            node_reference('sylvamo_products', concat('roll:', matched_roll_number))\n        else null\n    end as roll,\n    \n    -- Quality metadata\n    to_timestamp(cast(date as string)) as inspectionDate,\n    \n    -- Defect information\n    coalesce(\n        cast(what_was_the_defect as string),\n        cast(defect as string)\n    ) as defectType,\n    cast(defect as string) as defectDescription,\n    \n    -- Parse minutes lost (may be text)\n    case\n        when minutes_lost is not null and cast(minutes_lost as string) != '' then\n            try_cast(minutes_lost as double)\n        else null\n    end as minutesLost,\n    \n    -- Rejection status\n    case\n        when lower(cast(was_the_roll_rejected as string)) = 'yes' then true\n        when lower(cast(was_the_roll_rejected as string)) = 'no' then false\n        else null\n    end as rejected,\n    \n    -- Location/equipment\n    cast(location as string) as location,\n    \n    -- Link to FunctionalLocation (via Roll \u2192 Reel \u2192 FunctionalLocation)\n    -- For now, set to null - can be populated via follow-up transformation\n    null as functionalLocation,\n    \n    -- Source system tracking\n    'SharePoint' as sourceSystem\n    \nfrom roll_matching\nwhere primary_roll_id is not null\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_QualityResult_from_SharePoint",
    "name": "[Products] Populate QualityResult from SharePoint Roll Quality",
    "query": "/*\n   Transformation: Populate QualityResult from SharePoint Roll Quality\n   \n   Purpose:\n   - Reads quality inspection data from SharePoint (via SharePoint Extractor)\n   - Creates QualityResult nodes linking to Roll entities\n   - Links to FunctionalLocation via Roll \u2192 Reel \u2192 FunctionalLocation chain\n   \n   Source RAW Table: raw_ext_sharepoint.roll_quality\n   Destination: sylvamo_products.QualityResult view (v1)\n   \n   Roll ID Format Challenge:\n   - SharePoint uses: E15M06043C (format: E + digits + letter) in 'title' field\n   - Roll table uses: EME13B08061N (format: EM + digits + letter) in 'roll_number'\n   - Solution: Use 'title' as primary source, try multiple matching strategies\n   - Matching: Direct match, remove EM prefix, add EM prefix, case-insensitive\n*/\n\n-- Create QualityResult instances from all SharePoint roll_quality rows\n-- Use 'key' field (row identifier) which contains the roll ID, fallback to 'title' column\nselect\n    -- Instance identification (use key/title + date as unique identifier)\n    concat(\n        'quality:',\n        coalesce(cast(date as string), 'unknown'),\n        ':',\n        coalesce(key, cast(title as string), 'unknown')\n    ) as externalId,\n    'sylvamo_products' as space,\n    \n    -- Quality identifiers\n    concat(\n        'quality:',\n        coalesce(cast(date as string), 'unknown'),\n        ':',\n        coalesce(key, cast(title as string), 'unknown')\n    ) as qualityResultId,\n    \n    -- Production entity references (use key/title as roll ID)\n    coalesce(key, cast(title as string)) as rollNumber,\n    \n    -- Roll relation (null for now - can be populated via separate transformation)\n    null as roll,\n    \n    -- Quality metadata\n    to_timestamp(cast(date as string)) as inspectionDate,\n    \n    -- Defect information\n    coalesce(\n        cast(what_was_the_defect as string),\n        cast(defect as string),\n        cast(defect_non_damage as string)\n    ) as defectType,\n    coalesce(\n        cast(defect as string),\n        cast(defect_non_damage as string)\n    ) as defectDescription,\n    \n    -- Parse minutes lost\n    case\n        when minutes_lost is not null and cast(minutes_lost as string) != '' then\n            try_cast(minutes_lost as double)\n        else null\n    end as minutesLost,\n    \n    -- Rejection status\n    case\n        when lower(cast(was_the_roll_rejected as string)) = 'yes' then true\n        when lower(cast(was_the_roll_rejected as string)) = 'no' then false\n        else null\n    end as rejected,\n    \n    -- Location/equipment\n    cast(location as string) as location,\n    \n    -- FunctionalLocation (null for now)\n    null as functionalLocation,\n    \n    -- Source system\n    'SharePoint' as sourceSystem\n    \nfrom `raw_ext_sharepoint`.`roll_quality`\nwhere (key is not null and cast(key as string) != '') or (title is not null and cast(title as string) != '')\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr-sap-asset-hierarchy",
    "name": "sap-asset-hierarchy",
    "query": "/* Create asset hierarchy from SAP data which includes Eastover */\n\nselect\n  concat(\"floc:\", `functional_location`) as externalId,\n  concat( \"floc:\", substring_index(`functional_location`, \"-\", (`hierarchy_level` - 1)) ) as parentExternalId,  -- remove everything after the last \"-\", if the functional location is \"0769-01-02\" then the parent asset's functional location is \"0769-01\"\n  \"SAP Asset Hierarchy\" as source,\n  `functional_location_description` as name,\n  map(\n  \t\"work_center_code\", `work_center_code`,\n  \t\"work_center_description\", `work_center_description`,\n  \t\"functional_location\", `functional_location`\n  ) as metadata,\n  dataset_id(\"ds_asset_Eastover\") as dataSetId\nfrom `raw_ext_sap`.`asset_hierarchy` as raw\n-- inner join _cdf.assets as cdf_assets\n-- \ton cdf_assets.externalId == concat( \"floc:\", substring_index(`functional_location`, \"-\", (`hierarchy_level` - 1)) )\nwhere `functional_location_description` is not NULL  -- a handful of assets don't have names (but do have functional locations) which should be investigated\n\t-- and `hierarchy_level` == 9",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "TransformationDestination"
  },
  {
    "external_id": "tr-sap-production-orders",
    "name": "sap-production-orders",
    "query": "/* Create production orders from SAP as events */\n\nselect\n  cast(`basic_start_date` as date) as startTime,\n  cast(`basic_finish_date` as date) as endTime,\n  -- as description,\n  \"Production Order\" as type,\n  -- as metadata,\n  -- as assetIds,\n  \"SAP\" as source,\n  -- as externalId,\n  dataset_id(\"ds_SAP_production_orders\") as dataSetId\nfrom `raw_ext_sap`.`production_orders`",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "TransformationDestination"
  },
  {
    "external_id": "tr-sap-work-orders",
    "name": "sap-work-orders",
    "query": "/* Create work orders from SAP as events and link them to the asset hierarchy where possible */\n\nselect\n  cast(wo.`order_created_date` as timestamp) as startTime,\n  wo.`work_order_description` as description,\n  \"Work Order\" as type,\n  map(\n  \t\"work_order_number\", cast(wo.`work_order_number` as bigint),\n  \t\"functional_location\", wo.`functional_location`,\n  \t\"equipment_number\", wo.`equipment_number`,\n  \t\"equipment_description\", wo.`equipment_description`\n  ) as metadata,\n  array(ca.id) as assetIds,  -- connects work order to asset in hierarchy\n  \"SAP\" as source,\n  concat(\"wo_\", cast(wo.`work_order_number` as bigint)) as externalId,\n  dataset_id(\"ds_SAP_work_orders\") as dataSetId\nfrom `raw_ext_sap`.`work_orders` as wo\nleft join _cdf.assets as ca\n  on wo.`functional_location` == ca.`metadata`[\"functional_location\"]\nwhere ca.id is not null\n\n\n\nselect *\nfrom `raw_ext_sharepoint`.`roll_quality_v2`\nwhere `Title` == 'E16A24081Z'",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "TransformationDestination"
  },
  {
    "external_id": "tr_populate_Event_Proficy",
    "name": "Populate Event from Proficy Events Tests",
    "query": "-- cdf-auth: f9b1f784\n/*\n    Transformation: Populate Event from Proficy Events Tests\n    Source: raw_ext_sql_proficy.events_tests\n    Target: sylvamo_mfg_core_schema.Event (v1)\n    \n    Maps Proficy production events to the MfgEvent container.\n    External IDs use 'proficy-event:' prefix for consistency.\n    \n    NOTE: Deduplicates on event_id to avoid constraint violations.\n*/\n\nSELECT\n    externalId,\n    space,\n    name,\n    description,\n    startTime,\n    endTime,\n    sourceId,\n    eventType,\n    eventSubtype,\n    resultValue,\n    resultText,\n    unit,\n    isInSpec,\n    sourceSystem,\n    asset\nFROM (\n    SELECT\n        concat('proficy-event:', cast(`event_id` as STRING)) as externalId,\n        'sylvamo_mfg_core_instances' as space,\n        \n        -- CDM Describable properties\n        concat('Event ', cast(`Event_Num` as STRING)) as name,\n        concat('Proficy Event #', cast(`Event_Num` as STRING), ' - Var: ', cast(`Var_Id` as STRING)) as description,\n        \n        -- CDM Activity properties (startTime, endTime)\n        to_timestamp(cast(`Productive_Start_Time` as STRING)) as startTime,\n        to_timestamp(cast(`Productive_End_Time` as STRING)) as endTime,\n        \n        -- CDM Sourceable properties\n        cast(`event_id` as STRING) as sourceId,\n        \n        -- MfgEvent properties\n        'ProductionEvent' as eventType,\n        cast(`Var_Id` as STRING) as eventSubtype,\n        cast(`Result` as DOUBLE) as resultValue,\n        cast(null as STRING) as resultText,\n        cast(null as STRING) as unit,\n        cast(null as BOOLEAN) as isInSpec,\n        'Proficy' as sourceSystem,\n        \n        -- Asset relation: Map PU_Id to Paper Machine functional locations\n        -- PU_Id 4 = PM1 (#1 Paper Machine), PU_Id 5 = PM2 (#2 Paper Machine)\n        CASE\n            WHEN `PU_Id` = 4 THEN node_reference('sylvamo_mfg_core_instances', 'floc:0769-06-01-010')\n            WHEN `PU_Id` = 5 THEN node_reference('sylvamo_mfg_core_instances', 'floc:0769-06-01-020')\n            ELSE cast(null as STRUCT<space: STRING, externalId: STRING>)\n        END as asset,\n        \n        row_number() OVER (PARTITION BY `event_id` ORDER BY `Productive_Start_Time` DESC) as rn\n    FROM `raw_ext_sql_proficy`.`events_tests`\n    WHERE `event_id` IS NOT NULL\n) deduped\nWHERE rn = 1\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_test_fix_asset_paths",
    "name": "[Test] Fix Asset Hierarchy Paths",
    "query": "\nSELECT\n    cast(asset.externalId AS STRING) AS externalId,\n    cast(asset.name AS STRING) AS name,\n    cast(asset.description AS STRING) AS description,\n    (CASE \n        WHEN isnull(asset.parentExternalId) THEN null\n        ELSE node_reference('sylvamo_mfg_core_instances', cast(asset.parentExternalId AS STRING))\n    END) AS parent,\n    cast(asset.externalId AS STRING) AS sourceId\nFROM \n    cdf_assetSubtree('floc:0769') AS asset\nWHERE \n    asset.externalId IN (\n        'floc:0769-03-03-020-010-020',\n        'floc:0769-03-03-020-010-015'\n    )\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_fernando_ts_asset_pm1",
    "name": "Fernando Test - TS Asset Linkage PM1",
    "query": "\n-- Find all time series connected to Paper Machine 1\n-- Created by: fernando.barsoba\nSELECT\n    node.externalId as `key`,\n    node.externalId as ts_external_id,\n    node.name as ts_name,\n    node.description as ts_description,\n    node.piTagName as pi_tag,\n    node.measurementType as measurement_type,\n    'floc:0769-06-01-010' as connected_asset,\n    'Paper Machine 1' as asset_name\nFROM cdf_data_models(\"sylvamo_mfg_core_schema\", \"SylvamoMfgCore\", \"v1\", \"MfgTimeSeries\") as node\nWHERE array_contains(\n    node.assets,\n    named_struct('space', 'sylvamo_mfg_core_instances', 'externalId', 'floc:0769-06-01-010')\n)\nORDER BY ts_external_id\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "RawTable"
  },
  {
    "external_id": "tr_fernando_ts_asset_pm2",
    "name": "Fernando Test - TS Asset Linkage PM2",
    "query": "\n-- Find all time series connected to Paper Machine 2\n-- Created by: fernando.barsoba\nSELECT\n    node.externalId as `key`,\n    node.externalId as ts_external_id,\n    node.name as ts_name,\n    node.description as ts_description,\n    node.piTagName as pi_tag,\n    node.measurementType as measurement_type,\n    'floc:0769-06-01-020' as connected_asset,\n    'Paper Machine 2' as asset_name\nFROM cdf_data_models(\"sylvamo_mfg_core_schema\", \"SylvamoMfgCore\", \"v1\", \"MfgTimeSeries\") as node\nWHERE array_contains(\n    node.assets,\n    named_struct('space', 'sylvamo_mfg_core_instances', 'externalId', 'floc:0769-06-01-020')\n)\nORDER BY ts_external_id\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "RawTable"
  },
  {
    "external_id": "tr_fernando_link_ts_to_assets",
    "name": "Fernando - Link TimeSeries to Assets (Classic API)",
    "query": "\n-- Link Time Series to Assets (Classic API)\n-- Created by: fernando.barsoba\n-- Purpose: Fix Data Explorer and Search visibility\n\nSELECT\n    ts.externalId as externalId,\n    \n    -- Link to asset based on PI tag prefix or name pattern\n    CASE\n        -- PI tags for PM1 (471*)\n        WHEN ts.externalId LIKE 'pi:471%'\n        THEN (SELECT id FROM _cdf.assets WHERE externalId = 'floc:0769-06-01-010' LIMIT 1)\n        \n        -- PI tags for PM2 (472*)\n        WHEN ts.externalId LIKE 'pi:472%'\n        THEN (SELECT id FROM _cdf.assets WHERE externalId = 'floc:0769-06-01-020' LIMIT 1)\n        \n        -- Proficy readings with Paper Machine 1 in name\n        WHEN ts.name LIKE '%Paper Machine 1%'\n        THEN (SELECT id FROM _cdf.assets WHERE externalId = 'floc:0769-06-01-010' LIMIT 1)\n        \n        -- Proficy readings with Paper Machine 2 in name\n        WHEN ts.name LIKE '%Paper Machine 2%'\n        THEN (SELECT id FROM _cdf.assets WHERE externalId = 'floc:0769-06-01-020' LIMIT 1)\n        \n        ELSE NULL\n    END as assetId\n\nFROM _cdf.timeseries ts\nWHERE \n    -- Only process time series that match our patterns\n    (\n        ts.externalId LIKE 'pi:471%'\n        OR ts.externalId LIKE 'pi:472%'\n        OR ts.name LIKE '%Paper Machine 1%'\n        OR ts.name LIKE '%Paper Machine 2%'\n    )\n    -- Only update if not already linked\n    AND ts.assetId IS NULL\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "TransformationDestination"
  },
  {
    "external_id": "tr_populate_ProficyDatapoints",
    "name": "Populate Proficy Datapoints from RAW",
    "query": "-- cdf-auth: f9b1f784\n/*\n    Transformation: Populate Proficy Datapoints\n    Source: raw_ext_sql_proficy.events_tests\n    Target: Time Series datapoints\n    \n    Ingests datapoints from Proficy readings into CDF Time Series.\n    \n    IMPORTANT:\n    - Uses Var_Id to match time series external_id: proficy:ts_{Var_Id}\n    - Timestamps from Productive_Start_Time\n    - Values from Result column\n    \n    RAW Table: events_tests\n    - Var_Id: Variable/Tag identifier (matches Tag in tag_info)\n    - Result: Numeric measurement value\n    - Productive_Start_Time: Timestamp of the reading\n    \n    NOTE: This transformation requires the time series to exist first.\n    Run populate_ProficyTimeSeries transformation before this one.\n*/\n\nSELECT\n    -- Time series external ID: must match the pattern in populate_ProficyTimeSeries\n    concat('proficy:ts_', cast(`Var_Id` as STRING)) as externalId,\n    \n    -- Timestamp: convert to proper timestamp format\n    to_timestamp(`Productive_Start_Time`) as timestamp,\n    \n    -- Value: the measurement result\n    cast(`Result` as DOUBLE) as value\n\nFROM `raw_ext_sql_proficy`.`events_tests`\nWHERE `Var_Id` IS NOT NULL\n  AND `Result` IS NOT NULL\n  AND `Productive_Start_Time` IS NOT NULL\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "TransformationDestination"
  },
  {
    "external_id": "tr_populate_ProficyEventIdDatapoints",
    "name": "Populate Proficy Event ID String Datapoints",
    "query": "-- cdf-auth: f9b1f784\n/*\n    Transformation: Populate Proficy Event ID String Datapoints\n    Source: raw_ext_sql_proficy.events_tests\n    Target: Time Series string datapoints\n    \n    Ingests Event_Num (Event ID) string values from Proficy readings into CDF Time Series.\n    Maps events by PU_Id to the correct machine's Event_Num time series:\n    - PU_Id=4 -> proficy:ts_eventid_pm1 (Paper Machine 1)\n    - PU_Id=5 -> proficy:ts_eventid_pm2 (Paper Machine 2)\n    \n    RAW Table: events_tests\n    - PU_Id: Production Unit ID (4=PM1, 5=PM2)\n    - Event_Num: Event ID string value\n    - Productive_Start_Time: Timestamp of the reading\n    \n    NOTE: This transformation requires the string time series to exist first.\n    Run create_ProficyEventIdTimeSeries_CDF transformation before this one.\n    \n    RELATED JIRA: SVQS-185\n*/\n\nSELECT\n    -- Time series external ID: map by PU_Id to machine-specific Event ID time series\n    CASE\n        WHEN `PU_Id` = 4 THEN 'proficy:ts_eventid_pm1'\n        WHEN `PU_Id` = 5 THEN 'proficy:ts_eventid_pm2'\n    END as externalId,\n    \n    -- Timestamp: convert to proper timestamp format\n    to_timestamp(`Productive_Start_Time`) as timestamp,\n    \n    -- String value: the Event_Num (Event ID)\n    cast(`Event_Num` as STRING) as value\n\nFROM `raw_ext_sql_proficy`.`events_tests`\nWHERE `PU_Id` IN (4, 5)\n  AND `Event_Num` IS NOT NULL\n  AND `Productive_Start_Time` IS NOT NULL\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "TransformationDestination"
  },
  {
    "external_id": "pi_timeseries_springfield_aveva_pi",
    "name": "TimeSeries Transformations for Springfield AVEVA PI",
    "query": "select \n  externalId as externalId,\n  name as name,\n  'numeric' as type,\n  false as isStep,\n  if(try_get_unit(`unit`) IS NOT NULL, node_reference('cdf_cdm_units', try_get_unit(`unit`)), NULL) as unit,\n  `unit` as sourceUnit\n  \nfrom `ingestion`.`timeseries_metadata`",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "sap_assets_springfield_s4hana",
    "name": "Asset Transformations for SAP Springfield S/4HANA Assets",
    "query": "with parentLookup as (\n  select\n  \tconcat('WMT:', cast(d1.`WMT_TAG_NAME` as STRING)) as externalId,\n    node_reference('springfield_instances',  concat('WMT:', cast(d2.`WMT_TAG_NAME` as STRING))) as parent\n  from\n      `ingestion`.`dump` as  d1\n  join\n    `ingestion`.`dump` as d2\n  on\n    d1.`WMT_TAG_ID_ANCESTOR` = d2.`WMT_TAG_ID`\n  where\n    isnotnull(d1.`WMT_TAG_NAME`) AND\n    -- cast(d1.`WMT_CATEGORY_ID` as INT) = 1157 AND\n    isnotnull(d2.`WMT_TAG_NAME`) \n\t-- AND cast(d2.`WMT_CATEGORY_ID` as INT) = 1157\n)\nselect\n\tconcat('WMT:', cast(d3.`WMT_TAG_NAME` as STRING)) as externalId,\n  \tparentLookup.parent,\n    cast(`WMT_TAG_NAME` as STRING) as name,\n    cast(`WMT_TAG_DESC` as STRING) as description,\n    cast(`WMT_TAG_ID` as STRING) as sourceId,\n    cast(`WMT_TAG_CREATED_DATE` as TIMESTAMP) as sourceCreatedTime,\n    cast(`WMT_TAG_UPDATED_DATE` as TIMESTAMP) as sourceUpdatedTime,\n    cast(`WMT_TAG_UPDATED_BY` as STRING) as sourceUpdatedUser\nfrom\n  `ingestion`.`dump` as d3\nleft join\n\tparentLookup\non\n concat('WMT:', cast(d3.`WMT_TAG_NAME` as STRING)) = parentLookup.externalId\nwhere\n  isnotnull(d3.`WMT_TAG_NAME`)\n/* Inspection of the WMT_TAG_DESC looks like asset are category 1157 while equipment is everything else */\n  -- AND cast(d3.`WMT_CATEGORY_ID` as INT) = 1157\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "sap_equipment_springfield_s4hana",
    "name": "Equipment Transformations for SAP Springfield S/4HANA Assets",
    "query": "/* MAPPING_MODE_ENABLED: false */\n/* {\"version\":1,\"sourceType\":\"raw\",\"mappings\":[{\"from\":\"externalId\",\"to\":\"externalId\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"aliases\",\"asType\":\"ARRAY<STRING>\"},{\"from\":\"name\",\"to\":\"name\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"source\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"path\",\"asType\":\"ARRAY<STRUCT<`space`:STRING, `externalId`:STRING>>\"},{\"from\":\"\",\"to\":\"root\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"assetClass\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"sourceUpdatedUser\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"pathLastUpdatedTime\",\"asType\":\"TIMESTAMP\"},{\"from\":\"\",\"to\":\"sourceUpdatedTime\",\"asType\":\"TIMESTAMP\"},{\"from\":\"\",\"to\":\"type\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"sourceCreatedUser\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"parent\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"description\",\"to\":\"description\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"tags\",\"asType\":\"ARRAY<STRING>\"},{\"from\":\"\",\"to\":\"sourceCreatedTime\",\"asType\":\"TIMESTAMP\"},{\"from\":\"\",\"to\":\"sourceContext\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"sourceId\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"object3D\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"}],\"sourceLevel1\":\"sap_staging\",\"sourceLevel2\":\"dump\"} */\nselect\n  concat('WMT:', cast(`WMT_TAG_NAME` as STRING)) as externalId,\n  cast(`WMT_TAG_NAME` as STRING) as name,\n  cast(`WMT_TAG_DESC` as STRING) as description,\n  cast(`WMT_TAG_ID` as STRING) as sourceId, \n  cast(`WMT_TAG_CREATED_DATE` as TIMESTAMP) as sourceCreatedTime,\n  cast(`WMT_TAG_UPDATED_DATE` as TIMESTAMP) as sourceUpdatedTime,\n  cast(`WMT_TAG_UPDATED_BY` as STRING) as sourceUpdatedUser,\n  cast(`WMT_CONTRACTOR_ID` as STRING) as manufacturer,\n  cast(`WMT_TAG_GLOBALID` as STRING) as serialNumber\nfrom\n  `ingestion`.`dump`\nwhere\n  isnotnull(`WMT_TAG_NAME`) AND\n  cast(`WMT_CATEGORY_ID` as INT) != 1157\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "sap_equipment_to_asset_springfield_s4hana",
    "name": "Equipment to Asset Transformations for SAP Springfield S/4HANA Assets",
    "query": "select\n  concat('WMT:', cast(d1.`WMT_TAG_NAME` as STRING)) as externalId,\n  node_reference('springfield_instances',  concat('WMT:', cast(d2.`WMT_TAG_NAME` as STRING))) as asset\nfrom\n    ingestion.`dump` d1\njoin\n  ingestion.`dump` d2\non\n  d1.`WMT_TAG_ID_ANCESTOR` = d2.`WMT_TAG_ID`\nwhere\n  isnotnull(d1.`WMT_TAG_NAME`) AND\n  cast(d1.`WMT_CATEGORY_ID` as INT) != 1157 AND\n  isnotnull(d2.`WMT_TAG_NAME`) AND\n  cast(d2.`WMT_CATEGORY_ID` as INT) = 1157\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "files_metadata_springfield",
    "name": "File Transformations for Springfield Sharepoint",
    "query": "select\n\tconcat('VAL_', name) as externalId,\n \tname,\n\tsource as sourceId,\n\tmime_type as mimeType\nfrom `ingestion`.`files_metadata`\nwhere\n\tisnotnull(mime_type) and\n\tmime_type = 'application/pdf'\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "sap_maintenance_orders_springfield_s4hana",
    "name": "Maintenance Order Transformations for SAP Springfield S/4HANA Activities",
    "query": "/* MAPPING_MODE_ENABLED: false */\n/* {\"version\":1,\"sourceType\":\"raw\",\"mappings\":[{\"from\":\"externalId\",\"to\":\"externalId\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"aliases\",\"asType\":\"ARRAY<STRING>\"},{\"from\":\"name\",\"to\":\"name\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"source\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"path\",\"asType\":\"ARRAY<STRUCT<`space`:STRING, `externalId`:STRING>>\"},{\"from\":\"\",\"to\":\"root\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"assetClass\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"sourceUpdatedUser\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"pathLastUpdatedTime\",\"asType\":\"TIMESTAMP\"},{\"from\":\"\",\"to\":\"sourceUpdatedTime\",\"asType\":\"TIMESTAMP\"},{\"from\":\"\",\"to\":\"type\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"\",\"to\":\"sourceCreatedUser\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"parent\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"},{\"from\":\"description\",\"to\":\"description\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"tags\",\"asType\":\"ARRAY<STRING>\"},{\"from\":\"\",\"to\":\"sourceCreatedTime\",\"asType\":\"TIMESTAMP\"},{\"from\":\"\",\"to\":\"sourceContext\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"sourceId\",\"asType\":\"STRING\"},{\"from\":\"\",\"to\":\"object3D\",\"asType\":\"STRUCT<`space`:STRING, `externalId`:STRING>\"}],\"sourceLevel1\":\"sap_staging\",\"sourceLevel2\":\"dump\"} */\nselect\n  cast(`sourceId` as STRING) as externalId,\n  cast(`WORKORDER_DESC` as STRING) as description,\n  cast(`WORKORDER_TITLE` as STRING) as name,\n  cast(`WORKORDER_STATUS` as STRING) as status,\n  cast(`WORKORDER_SCHEDULEDSTART` as TIMESTAMP) as scheduledStartTime,\n  cast(`WORKORDER_DUEDATE` as TIMESTAMP) as scheduledEndTime,\n  cast(`WORKORDER_PLANNEDSTART` as TIMESTAMP) as startTime,\n  cast(`WORKORDER_COMPLETIONDATE` as TIMESTAMP) as endTime,\n  cast(`WORKORDER_CREATEDDATE` as TIMESTAMP) as sourceCreatedTime,\n  cast(`WORKORDER_MAITENANCETYPE` as STRING) as type,\n  cast(`WORKORDER_PRIORITYDESC` as STRING) as priorityDescription\nfrom\n  `ingestion`.`workorder`\nwhere\n  isnotnull(`sourceId`)\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "sap_operations_springfield_s4hana",
    "name": "Operation Transformations for SAP Springfield S/4HANA Activities",
    "query": "-- The source data has duplicates this filters them out.\nwith unique_workitem as (\n  select\n    *,\n    row_number() over (partition by `sourceId` order by `sourceId`) as rn\n  from\n    `ingestion`.`workitem`\n)\nselect\n  cast(`sourceId` as STRING) as externalId,\n  cast(`WORKORDER_TASKNAME` as STRING) as name,\n  cast(`WORKORDER_STATUS` as STRING) as status,\n  array(cast(`WORKORDER_ITEMNAME` as STRING)) as tags\nfrom\n  unique_workitem\nwhere\n  isnotnull(`sourceId`) and\n  rn = 1",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "sap_operation_to_maintenance_order_springfield_s4hana",
    "name": "Operation to Maintenance Order for SAP Springfield S/4HANA Activities",
    "query": "/* The WORKORDER_NUMBER is not unique in the workorder table,\nso use the following query to select the first match. */\nwith unique_workitem as (\n  select\n    *,\n    row_number() over (partition by `sourceId` order by `sourceId`) as rn\n  from\n    ingestion.`workitem`\n),\nworder_unique as (\n  select\n    *,\n    row_number() over (partition by `WORKORDER_NUMBER` order by `sourceId`) as rn\n  from\n    ingestion.`workorder`\n)\nselect\n  cast(task.`sourceId` as STRING) as externalId,\n  node_reference('springfield_instances', cast(worder.`sourceId` as STRING)) as maintenanceOrder\nfrom\n  unique_workitem as task\njoin\n  worder_unique as worder\non\n  task.`WORKORDER_NUMBER` = worder.`WORKORDER_NUMBER`\nwhere\n  isnotnull(task.`sourceId`) AND\n  isnotnull(task.`WORKORDER_NUMBER`) AND\n  isnotnull(worder.`WORKORDER_NUMBER`) AND\n  isnotnull(worder.`sourceId`) AND\n  worder.rn = 1 AND\n  task.rn = 1\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "activity_to_asset",
    "name": "Activity to asset Connection Transformation",
    "query": "select\n  /* three first properties are required */\n  cast(activity.`externalId` as STRING) as externalId,\n  /* direct relation */\n  array(\n    node_reference(\n      'springfield_instances',\n      asset_lookup.`externalId`\n    )\n  ) as asset\nfrom\n  cdf_data_models(\n    \"cdf_cdm\",\n    \"CogniteCore\",\n    \"v1\",\n    \"CogniteActivity\"\n  ) as activity\nleft join cdf_data_models(\n    \"cdf_cdm\",\n    \"CogniteCore\",\n    \"v1\",\n    \"CogniteAsset\"\n  ) as asset_lookup\n  /* update to the correct matching criteria for your data */\non\n  activity.`tags`[0]  == asset_lookup.`name`\nwhere\n  activity.space == 'springfield_instances' and\n  isnotnull(activity.tags) and\n  asset_lookup.space == 'springfield_instances' and\n  isnotnull(asset_lookup.`externalId`)\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "activity_to_equipment",
    "name": "Activity to equipment Connection Transformation",
    "query": "select\n  /* three first properties are required */\n  cast(activity.`externalId` as STRING) as externalId,\n  /* direct relation */\n  array(\n    node_reference(\n      'springfield_instances',\n      equipment_lookup.`externalId`\n    )\n  ) as equipment\nfrom\n  cdf_data_models(\n    \"cdf_cdm\",\n    \"CogniteCore\",\n    \"v1\",\n    \"CogniteActivity\"\n  ) as activity\nleft join cdf_data_models(\n    \"cdf_cdm\",\n    \"CogniteCore\",\n    \"v1\",\n    \"CogniteEquipment\"\n  ) as equipment_lookup\n  /* update to the correct matching criteria for your data */\non\n  activity.`tags`[0]  == equipment_lookup.`name`\nwhere\n  activity.space == 'springfield_instances' and\n  isnotnull(activity.tags) and\n  equipment_lookup.space == 'springfield_instances' and\n  isnotnull(equipment_lookup.`externalId`)\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "activity_to_timeseries",
    "name": "Activity to timeseries Connection Transformation",
    "query": "select\n  /* three first properties are required */\n  cast(activity.`externalId` as STRING) as externalId,\n  /* direct relation */\n  collect_list(\n    node_reference(\n      'springfield_instances',\n      timeseries_lookup.`externalId`\n    )\n  ) as timeSeries\nfrom\n  cdf_data_models(\n    \"cdf_cdm\",\n    \"CogniteCore\",\n    \"v1\",\n    \"CogniteActivity\"\n  ) as activity\nleft join cdf_data_models(\n    \"cdf_cdm\",\n    \"CogniteCore\",\n    \"v1\",\n    \"CogniteTimeSeries\"\n  ) as timeseries_lookup\n  /* update to the correct matching criteria for your data */\non\n  activity.`tags`[0]  = substring_index(replace(timeseries_lookup.`name`, 'VAL_', ''), ':', 1)\nwhere\n  activity.space == 'springfield_instances' and\n  isnotnull(activity.tags) and\n  isnotnull(activity.`externalId`) and\n  timeseries_lookup.space == 'springfield_instances' and\n  isnotnull(timeseries_lookup.`name`)\ngroup by\n  activity.`externalId`",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "timeseries_to_asset",
    "name": "TimeSeries to asset Connection Transformation",
    "query": "select\n  /* three first properties are required */\n  cast(timeseries.`externalId` as STRING) as externalId,\n  cast(timeseries.`isStep` as BOOLEAN) as isStep,\n  cast(timeseries.`type` as STRING) as type,\n  /* direct relation */\n  array(\n    node_reference(\n      'springfield_instances',\n      asset_lookup.`externalId`\n    )\n  ) as assets\nfrom\n  cdf_data_models(\n    \"cdf_cdm\",\n    \"CogniteCore\",\n    \"v1\",\n    \"CogniteTimeSeries\"\n  ) as timeseries\nleft join cdf_data_models(\n    \"cdf_cdm\",\n    \"CogniteCore\",\n    \"v1\",\n    \"CogniteAsset\"\n  ) as asset_lookup\n  /* update to the correct matching criteria for your data */\n  on substring_index(replace(timeseries.`name`, 'VAL_', ''), ':', 1) == asset_lookup.`name`\nwhere\n  timeseries.space == 'springfield_instances' and\n  isnotnull(timeseries.`externalId`) and\n  asset_lookup.space == 'springfield_instances' and\n  isnotnull(asset_lookup.`externalId`)\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "timeseries_to_equipment",
    "name": "TimeSeries to equipment Connection Transformation",
    "query": "select\n  /* three first properties are required */\n  cast(timeseries.`externalId` as STRING) as externalId, \n  cast(timeseries.`isStep` as BOOLEAN) as isStep,\n  cast(timeseries.`type` as STRING) as type,\n  /* direct relation */\n  array(\n    node_reference(\n      'springfield_instances',\n      equipment_lookup.`externalId`\n    )\n  ) as equipment\nfrom\n  cdf_data_models(\n    \"cdf_idm\",\n    \"CogniteProcessIndustries\",\n    \"v1\",\n    \"CogniteTimeSeries\"\n  ) as timeseries\nleft join cdf_data_models(\n    \"cdf_idm\",\n    \"CogniteProcessIndustries\",\n    \"v1\",\n    \"CogniteEquipment\"\n  ) as equipment_lookup \n  /* update to the correct matching criteria for your data */\n  on substring_index(replace(timeseries.`name`, 'VAL_', ''), ':', 1) == equipment_lookup.`name`\nwhere\n  timeseries.space == 'springfield_instances' and\n  isnotnull(timeseries.`externalId`) and\n  equipment_lookup.space == 'springfield_instances' and\n  isnotnull(equipment_lookup.`externalId`)\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr-anvar-playground",
    "name": "anvar-playground",
    "query": "SELECT \n    -- Applying the timezone logic we discussed\n    to_utc_timestamp(\n        to_timestamp(cast(`ROLL_MANUFACTURING_DATE` as STRING), 'yyyyMMdd'), \n        'US/Eastern'\n    ) as cutDate_UTC,\n    \n    -- Your specific Reel ID logic\n    node_reference(\n        'sylvamo_mfg_core_instances', \n        concat('reel:', cast(`ROLL_REEL_NUMBER` as STRING), '_', substring(cast(`ROLL_WINDER_DATE` as STRING), 1, 4))\n    ) as reel,\n\n    * -- This will pull all other columns for that roll\nFROM \n    `raw_ext_fabric_ppr`.`ppr_hist_roll` -- Replace this with your actual table or view name\nWHERE \n    `ROLL_NUMBER` = 'EME16A24123D'",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Instances"
  },
  {
    "external_id": "tr_populate_Equipment",
    "name": "Populate Equipment instances for RollQuality linkage",
    "query": "-- cdf-auth: f9b1f784\n/*\n    Transformation: Populate Equipment instances for RollQuality linkage\n    Target: sylvamo_mfg_core_schema.Equipment (v1)\n\n    Creates static equipment instances for Eastover Mill sheeters and roll prep.\n    These are the equipment types found in SharePoint quality reports.\n*/\n\nSELECT\n    'equip:sheeter_no_1' as externalId,\n    'sylvamo_mfg_core_instances' as space,\n    'Sheeter No.1' as name,\n    'Eastover Mill Sheeter No.1 - Finishing equipment' as description,\n    'sheeter_no_1' as sourceId,\n    'Sheeter' as equipmentType,\n    '1' as equipmentNumber,\n    'EAST' as plantCode,\n    -- Asset relation: link to Eastover Mill (if exists)\n    cast(null as STRUCT<space: STRING, externalId: STRING>) as asset\n\nUNION ALL\n\nSELECT\n    'equip:sheeter_no_2' as externalId,\n    'sylvamo_mfg_core_instances' as space,\n    'Sheeter No.2' as name,\n    'Eastover Mill Sheeter No.2 - Finishing equipment' as description,\n    'sheeter_no_2' as sourceId,\n    'Sheeter' as equipmentType,\n    '2' as equipmentNumber,\n    'EAST' as plantCode,\n    cast(null as STRUCT<space: STRING, externalId: STRING>) as asset\n\nUNION ALL\n\nSELECT\n    'equip:sheeter_no_3' as externalId,\n    'sylvamo_mfg_core_instances' as space,\n    'Sheeter No.3' as name,\n    'Eastover Mill Sheeter No.3 - Finishing equipment' as description,\n    'sheeter_no_3' as sourceId,\n    'Sheeter' as equipmentType,\n    '3' as equipmentNumber,\n    'EAST' as plantCode,\n    cast(null as STRUCT<space: STRING, externalId: STRING>) as asset\n\nUNION ALL\n\nSELECT\n    'equip:roll_prep' as externalId,\n    'sylvamo_mfg_core_instances' as space,\n    'Roll Prep' as name,\n    'Eastover Mill Roll Preparation area' as description,\n    'roll_prep' as sourceId,\n    'RollPrep' as equipmentType,\n    cast(null as STRING) as equipmentNumber,\n    'EAST' as plantCode,\n    cast(null as STRUCT<space: STRING, externalId: STRING>) as asset\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  },
  {
    "external_id": "tr_populate_Asset_Equipment",
    "name": "Populate Equipment as Asset nodes (ISA-95 aligned)",
    "query": "-- cdf-auth: f9b1f784\n/*\n    Transformation: Populate Equipment as Asset nodes (ISA-95 aligned)\n    Target: sylvamo_mfg_core_schema.Asset (v1)\n\n    Creates equipment as Asset nodes with assetType='Equipment'.\n    This follows ISA-95 standards where equipment are leaf nodes in the asset hierarchy.\n    Equipment types identified from SharePoint quality reports: Sheeter No.1/2/3, Roll Prep.\n\n    Note: These equipment assets can be linked to a parent area asset once\n    the area structure is defined in the hierarchy.\n*/\n\nSELECT\n    'asset:sheeter_no_1' as externalId,\n    'sylvamo_mfg_core_instances' as space,\n    'Sheeter No.1' as name,\n    'Eastover Mill Sheeter No.1 - Finishing equipment' as description,\n    'sheeter_no_1' as sourceId,\n    -- Asset properties\n    'Equipment' as assetType,\n    'EAST' as plantCode,\n    -- Equipment-specific properties\n    'Sheeter' as equipmentType,\n    '1' as equipmentNumber,\n    -- Parent relation: can link to area asset when available\n    cast(null as STRUCT<space: STRING, externalId: STRING>) as parent\n\nUNION ALL\n\nSELECT\n    'asset:sheeter_no_2' as externalId,\n    'sylvamo_mfg_core_instances' as space,\n    'Sheeter No.2' as name,\n    'Eastover Mill Sheeter No.2 - Finishing equipment' as description,\n    'sheeter_no_2' as sourceId,\n    'Equipment' as assetType,\n    'EAST' as plantCode,\n    'Sheeter' as equipmentType,\n    '2' as equipmentNumber,\n    cast(null as STRUCT<space: STRING, externalId: STRING>) as parent\n\nUNION ALL\n\nSELECT\n    'asset:sheeter_no_3' as externalId,\n    'sylvamo_mfg_core_instances' as space,\n    'Sheeter No.3' as name,\n    'Eastover Mill Sheeter No.3 - Finishing equipment' as description,\n    'sheeter_no_3' as sourceId,\n    'Equipment' as assetType,\n    'EAST' as plantCode,\n    'Sheeter' as equipmentType,\n    '3' as equipmentNumber,\n    cast(null as STRUCT<space: STRING, externalId: STRING>) as parent\n\nUNION ALL\n\nSELECT\n    'asset:roll_prep' as externalId,\n    'sylvamo_mfg_core_instances' as space,\n    'Roll Prep' as name,\n    'Eastover Mill Roll Preparation area' as description,\n    'roll_prep' as sourceId,\n    'Equipment' as assetType,\n    'EAST' as plantCode,\n    'RollPrep' as equipmentType,\n    cast(null as STRING) as equipmentNumber,\n    cast(null as STRUCT<space: STRING, externalId: STRING>) as parent\n",
    "has_schedule": false,
    "schedule": null,
    "destination_type": "Nodes"
  }
]